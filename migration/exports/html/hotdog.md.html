<p>Today we&#39;re going to write a program that tells you whether an image is a hotdog or not!</p>
<p>If you didn&#39;t get the reference, here&#39;s the scene from HBO&#39;s Silicon Valley</p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/ACmydtFDTGs?rel=0" frameborder="0" allow="autoplay; encrypted-media" style="margin: 0 auto;display:block;" allowfullscreen></iframe>

<p>Before we can start working on this, we need to ask how we can even get a computer to tell us what&#39;s in an image. The long answer is machine learning, a field of computer science that involves a lot of research and computational resources. The short answer is we&#39;ll use an API.</p>
<p>There are plenty of image recognition APIs and services such as Google Cloud&#39;s Cloud Vision API or AWS&#39; Amazon Rekognition, however, we&#39;re going to be using <a href="https://clarifai.com/">Clarifai</a> since we can easily use it for free with no hassle. We&#39;ll be using their API and, if you want to delve into their docs, you can find them right <a href="https://clarifai.com/developer/guide/">here</a>. For this tutorial, I&#39;ll be sticking with the code provided in their <a href="https://clarifai.com/developer/guide/">API Guide</a> in the &quot;Images&quot; section.</p>
<p>To begin, let&#39;s start up a repl on <a href="https://repl.it">Repl.it</a></p>
<p><img src="/public/images/blog/hotdog/python.gif" alt="replit python"></p>
<p>Then, in a new tab, <a href="https://clarifai.com/developer/account/signup">create a Clarifai account</a>.</p>
<p><img src="/public/images/blog/hotdog/signup.png" alt="clarifai signup"></p>
<p>Once you&#39;ve done so, go to the <a href="https://clarifai.com/developer/account/applcations">application dashboard</a> and select &quot;Create New Application&quot;</p>
<p><img src="/public/images/blog/hotdog/application.png" alt="clarifai applications"></p>
<p>Put in a name for your application and get the API key for that application</p>
<p><img src="/public/images/blog/hotdog/apikey.png" alt="clarifai apikey"></p>
<p>That&#39;s it for stuff outside the editor, now it&#39;s time to get working!</p>
<p>In the Python repl, create an <code>.env</code> file and put in your API key like so</p>
<pre><code>API_KEY=afadee25a3fa4ce192d66cae17f7200b
</code></pre>
<p>We&#39;re creating a <code>.env</code> file because the <code>.env</code> file is only accessible to the owner of the repl, making it a smart location for API keys or other secrets that you wouldn&#39;t want others to have access to. It&#39;s important that you do not put the key in quotes otherwise it will not work, for more info on <code>.env</code> files in Repl.it check out <a href="https://repl.it/site/docs/secret-keys">this post</a>.</p>
<p>Next, let&#39;s create a  <code>requirements.txt</code> file for our dependencies and put the following into its contents. We&#39;ll be needing <code>dotenv</code> so we can access the <code>.env</code> file as well as <code>clarifai</code> to use the Clarifai API via Python</p>
<pre><code>dotenv
clarifai
</code></pre>
<p>Let&#39;s start <code>main.py</code> by grabbing the api key from our <code>.env</code> file</p>
<pre><code class="language-python">import os

API_KEY = os.getenv(&quot;API_KEY&quot;)
</code></pre>
<p>Then we follow it with the imports we need for Clarifai</p>
<pre><code class="language-python">from clarifai.rest import ClarifaiApp
from clarifai.rest import Image
</code></pre>
<p>Using ClarifaiApp and our API key, we create our app</p>
<pre><code class="language-python">app = ClarifaiApp(api_key=API_KEY)
</code></pre>
<p>Next, we&#39;ll need to obtain a &quot;model&quot; for the app. The model represents the type of information to get from the image. In this case, we want to get a particular type of food so we&#39;ll use the &quot;food items&quot; model. If you&#39;re interested in the other models offered, check out Clarifai&#39;s <a href="https://clarifai.com/models">models page</a></p>
<pre><code class="language-python">model = app.models.get(&quot;food-items-v1.0&quot;)
</code></pre>
<p>As for the image I&#39;ll use a Wikipedia image of a hot dog</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Hot_dog_with_mustard.png/1200px-Hot_dog_with_mustard.png" alt="hot dog"></p>
<p>And, to use it with our model, we have Clarifai&#39;s <code>Image</code></p>
<pre><code class="language-python">url = &quot;https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Hot_dog_with_mustard.png/1200px-Hot_dog_with_mustard.png&quot;

image = Image(url=url)
</code></pre>
<p>Lastly, we <em>predict</em></p>
<pre><code class="language-python">result = model.predict([image])
</code></pre>
<p>The returned <code>result</code> is a dictionary that should look similar to this</p>
<p><img src="/public/images/blog/hotdog/response.png" alt="returned result"></p>
<p>Feel free to poke around and see what specific structures are in the object but the loop that will give us the tags Clarifai returns is</p>
<pre><code class="language-python">for concept in result[&quot;outputs&quot;][0][&quot;data&quot;][&quot;concepts&quot;]:
    print (concept[&quot;name&quot;])
</code></pre>
<p>Since we only care if the displayed food is a hot dog, let&#39;s check each tag for being either &quot;hotdog&quot; or &quot;hot dog&quot;</p>
<pre><code class="language-python">hotdog = False
for concept in result[&quot;outputs&quot;][0][&quot;data&quot;][&quot;concepts&quot;]:
    if concept[&quot;name&quot;] == &quot;hotdog&quot; or concept[&quot;name&quot;] == &quot;hot dog&quot;:
       hotdog = True
       break
if hotdog:
   print (&quot;Hotdog&quot;)
else:
   print (&quot;Not hotdog&quot;)
</code></pre>
<p>And, with that, we can now determine whether or not an image is a hot dog. Go ahead and try out different urls and see it work!</p>
<iframe height="400px" width="100%" src="https://repl.it/@yevbar/not-hotdog-simple?lite=true" scrolling="no" frameborder="no" allowtransparency="true" allowfullscreen="true" sandbox="allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-modals"></iframe>

<p>Of course, we can do a lot better than just a script that prints &quot;Hot dog&quot; or &quot;Not hot dog&quot;. If you remember from the Silicon Valley clip, they actually returned an image with the text &quot;Hot dog&quot; or &quot;Not hot dog&quot; on it. So, let&#39;s make that happen.</p>
<p>To do that with Python, we&#39;ll use the Python Imaging Library (PIL). I&#39;ll be using <a href="https://www.1001freefonts.com/hours.font">this</a> custom font but feel free to use your own. If you use this one, you&#39;ll download a zip file with the ttf as its contents. Once you extract the ttf file or get your own, upload it to your repl</p>
<p><img src="/public/images/blog/hotdog/upload.png" alt="replit upload files"></p>
<p>In order to use PIL, we&#39;ll need to add <code>pillow</code> to our requirements.txt</p>
<pre><code>dotenv
clarifai
pillow
</code></pre>
<p>With that in, let&#39;s add the needed imports in <code>app.py</code></p>
<pre><code class="language-python">from PIL import Image, ImageDraw, ImageFont
</code></pre>
<p>Since we&#39;ve been retrieving the image by a url, we don&#39;t actually have the image saved locally. However, we can use requests to obtain the image</p>
<pre><code class="language-python">import requests
from io import BytesIO

response = requests.get(url)
base = Image.open(BytesIO(response.content)).convert(&#39;RGBA&#39;)
</code></pre>
<p>Since I named my ttf file <code>font.ttf</code>, we&#39;ll prepare the text like so</p>
<pre><code class="language-python">size = width, height = pattern.size
draw = ImageDraw.Draw(pattern, &quot;RGBA&quot;)
font = ImageFont.truetype(&quot;font.ttf&quot;, 100)
</code></pre>
<p>We only want to write &quot;Hotdog&quot; if it&#39;s a hotdog and &quot;Not hot dog&quot; if it isn&#39;t so we need distinguish that. I also put in some shifts in placement so that the text is more centered</p>
<pre><code class="language-python">if hotdog:
  draw.text((275 10),&quot;Hotdog&quot;,(0, 0, 0, 255), font=font)
else:
  draw.text((50, 10),&quot;Not hotdog&quot;,(0, 0, 0, 255), font=font)
</code></pre>
<p>Since we used RGBA for coloring, we&#39;re going to have to save the file as a png</p>
<pre><code class="language-python">pattern.save(&quot;result.png&quot;)
</code></pre>
<p><img src="/public/images/blog/hotdog/hotdog.png" alt="hotdog"></p>
<p>With that, we&#39;ve put the characters from Silicon Valley to shame. However, we now need to resize the images because, if you provide a smaller image, the text will go out of view. So, proceeding the line assigning <code>size</code>, let&#39;s put the following</p>
<pre><code class="language-python">if size[0] &lt; 1200:
  base = base.resize((1200, size[1]*1200/size[0]))
size = width, height = base.size
</code></pre>
<p>The reason for the second <code>size</code> assignment is because we may have changed the size of the image in the line before.</p>
<p>Running now should resolve the issue with size. The next thing to tackle is the color of the text; if the text is white and the image is dark then we&#39;re fine but what about when they&#39;re both bright colors? To solve that, we should place the text inside a rectangle like subtitles.</p>
<p>First, let&#39;s make the determined string &quot;Hotdog&quot; or &quot;Not hotdog&quot; be a variable</p>
<pre><code class="language-python">text = &quot;Hotdog&quot; if hotdog else &quot;Not hotdog&quot;
</code></pre>
<p>Next, I&#39;m going to move the coordinates for the text into variables too</p>
<pre><code class="language-python">x = 275 if hotdog else 50
y = 10
</code></pre>
<p>With these variables, we can get the width of the rectangle needed then draw it</p>
<pre><code class="language-python">w, h = font.getsize(text)
draw.rectangle((x, y, x + w, y + h), fill=&#39;white&#39;)
</code></pre>
<p>Now we should always be able to read the text. As one final thing, let&#39;s make the background of the text green or red based on whether or not it&#39;s a hotdog</p>
<pre><code class="language-python">draw.rectange((x, y, x + w, y + h), fill=&quot;green&quot; if hotdog else &quot;red&quot;)
</code></pre>
<p><img src="/public/images/blog/hotdog/not_hotdog.png" alt="not hotdog"></p>
<p>As you can see, a hamster is not a hot dog and you made &quot;Not hotdog&quot; using Python!</p>
<p>As always if you have any questions or want to say hi, feel to send me an email at <a href="mailto:yev@repl.it">yev@repl.it</a> and till next time!</p>
