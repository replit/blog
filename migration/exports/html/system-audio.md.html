<p>We know that <a href="https://blog.replit.com/kaboom">games</a> are an important part of our commitment to making programming more accessible, more creative, and more fun. Back in February when we announced a significant revamp to our <a href="https://blog.replit.com/native-graphics-love#connect-with-us">graphics stack</a>, we also promised that we would also provide system audio integration. That support is finally available today, as an opt-in feature.</p>
<h2>How to opt-in</h2>
<p>We are firm believers in the &quot;Don&#39;t pay for what you don&#39;t use&quot; philosophy. Since enabling system-wide audio is moderately expensive, resource-wise, it&#39;s better for this feature to be opt-in. In order to do so, all you need to do is create <a href="https://docs.replit.com/repls/secret-keys">a secret</a> called <code>VNC_ENABLE_EXPERIMENTAL_AUDIO</code> with a value of <code>1</code> and restart your repl by running <code>kill 1</code> on the shell. Once that&#39;s done, a checkbox with headphones will appear in the lower right corner of the VNC output window:</p>
<p><img src="https://blog.replit.com/images/system-audio/system-audio.png" alt="look for the headphones" title="look for the headphones"></p>
<p>Due to restrictions in the browser security model, there needs to be an explicit user interaction when enabling the audio, which means that the checkbox needs to be manually toggled every time the repl is opened.</p>
<h2>How does it work?</h2>
<p>Linux (and other POSIX systems) users will probably be familiar with <a href="https://www.freedesktop.org/wiki/Software/PulseAudio/">PulseAudio</a> as the main component in the desktop audio experience, with compatibility layers for other sound systems like <a href="https://alsa-project.org/wiki/Main_Page">ALSA</a>. It&#39;s the userspace solution that has the widest support for gaming libraries and desktop applications. A few months ago when we decided to support audio in a system level, there was no pre-existing end-to-end way to get compressed audio from PulseAudio delivered alongside <a href="https://en.wikipedia.org/wiki/RFB_protocol">Remote Framebuffer</a>, the protocol that we use to display the graphic repls on the workspace.</p>
<p><img src="https://blog.replit.com/images/system-audio/how-products-are-born.png" alt="this is pretty much how products are born" title="this is pretty much how products are born"></p>
<p>So we set out to build that support. The easiest way to achieve this was to bundle the audio data inside the VNC connection using an RFB protocol extension, similar to how QEMU used to do this before they switched to the <a href="https://www.linux-kvm.org/page/SPICE">SPICE protocol</a>. That only allowed for uncompressed audio, which consumes <em>a lot</em> of bandwidth, so that was not an option for us. We also didn&#39;t quite want to maintain a set of floating patches for the VNC server that we use (X11 / XtigerVNC) so that it would be able to embed the audio data. One way to achieve this with minimal maintenance is to splice the audio data outside of that process: we were already using an external process (<a href="https://github.com/novnc/websockify">Websockify</a>) to convert the RFB connection from a raw TCP stream into a WebSocket connection, so changing that component for another added no extra overhead. Furthermore, since we wanted to change how the <a href="https://blog.replit.com/vnc-passwords">VNC authentication worked</a>, it meant that both efforts would benefit from this change: This is how our <a href="https://github.com/replit/rfbproxy">RFB proxy</a> written in Rust was born.</p>
<p><code>rfbproxy</code> connects to both XtigerVNC and PulseAudio, transcodes the audio into an <a href="https://opus-codec.org/">Opus</a> stream in a <a href="https://www.webmproject.org/">WebM</a> <a href="https://www.w3.org/TR/mse-byte-stream-format-webm/">streaming container</a> (with an MP3-in-MPEG fallback for browsers that don&#39;t support Opus/WebM), and delivers a unified RFB stream to the <a href="https://novnc.com">NoVNC</a> client.</p>
<p>Here&#39;s a snippet from the original design doc, that illustrates how all pieces work together:</p>
<pre><code>  [ Client app ][ALSA library] --(config files)--&gt; PulseAudio --\
     |    [PulseAudio library]  -----------------------^        |
     |                                                          |
     \-------------------&gt;  XtigerVNC                           |
                                |                               |
                                v                               |
    /-----------------------  rfbproxy  ------------------------/
    |
    \----------------------- RFB WebSocket
                                |
                                v
                          NoVNC + Web Audio
</code></pre>
<p>Extending a web protocol needs to be done with coordination with the rest of the community, since the changes could accidentally conflict with other projects. Fortunately, the <a href="https://iana.org">Internet Assigned Numbers Authority</a> helps with that by maintaining a canonical list of extensions to most protocols. A few weeks ago, we were granted assignments for the messages required to implement the <a href="https://www.iana.org/assignments/rfb/rfb.xhtml#rfb-2">Replit Audio extension</a> in the RFB protocol, so at that point we were finally able to move forward without fear of breaking things for anybody!</p>
<h2>Known limitations</h2>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API">Web Audio API</a> in most browsers have a buffer of 100-300 msec which we haven&#39;t found a way to reduce, so there is a 100-300 msec worth of latency that is added to the audio when compared against the video. There are also some known issues with Safari playback, since their security model is slightly different than Chrome or Firefox. Finally, due to OS scheduling and other resource constraints, non-<a href="http://replit.com/pricing">Hacker</a> repls <em>may</em> not be powerful enough to provide a smooth playback.</p>
<p>Happy gaming!</p>
