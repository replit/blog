<p>After many years of running on Heroku, Replit has fully migrated to Google Cloud Platform.</p>
<p>Why leave Heroku in the first place? Heroku served us well, but ultimately we recognized that our mission to bring the next billion software creators online would require an entirely new approach to our infrastructure. Our infrastructure needs to be flexible, and we need to have control across the entire stack - both data and hosting - to make moves to support our mission.</p>
<p>So, what did it take to migrate Replit?</p>
<h2>Step 1: Demo a Prototype</h2>
<p>We put together a quick demo of the website running in Google Cloud using a test database (with a fake dataset) to prove the concept would work. In this stage, we also gathered feedback and started to push the boundaries to understand where the problems might lurk later in the project.</p>
<p>We took some time to investigate alternate hosting systems and even clouds. Ultimately, because the rest of Replit&#39;s infrastructure is in Google Cloud, it made the most sense to stay with what we know.</p>
<h2>Step 2: Data Migration (Part 1)</h2>
<p>The Replit website uses a Postgres database and a handful of Redis caches. Heroku&#39;s managed database offerings can serve this use case with deep integration in the platform, but it was time for us to move.</p>
<p>Postgres migration required us to work with Heroku&#39;s Data Services team to access the write-ahead-log files for our database. Using a system called <a href="https://github.com/wal-e/wal-e">WAL-E</a> and access to an S3 bucket provided by Heroku&#39;s team, we set up a handful of very powerful GCP VMs running Postgres replicas of our database.</p>
<p>Once we could repeatedly build these replicas in GCP, we tested a handful of failure modes and rehearsed converting these from followers to leaders multiple times. We wrote every step of the process into a repl, so we had a playbook with each step mapped out when we migrated. Any mistake during the migration would extend downtime for our users, so every practice run was crucial to ensure we had the muscle memory to perform the migration.</p>
<p>We used Redis Labs&#39; Google Cloud marketplace product to set up replicas of our Heroku Redis databases and prepare for an active/passive swap there, too. We worked with Redis Labs support to validate our strategy and plan for potential failure modes.</p>
<p>On October 22, we took a 15-minute maintenance window. During this 15-minute window, we brought down the website (to stop all database updates and finalize replication) and then switched everything to the Google Cloud Redis and Postgres databases. When we exited the maintenance window, our website hosted in Heroku was now using databases hosted in Google Cloud.</p>
<h2>Step 3: Data Migration (Part 2)</h2>
<p>Now that we had our database running on self-hosted Postgres in Google Cloud, we wanted to move to Google Cloud SQL to offload the Postgres administration to Google.</p>
<p>Immediately after the 15-minute maintenance window on October 22, we began Postgres-native replication from the self-hosted Postgres VMs (<code>CREATE PUBLICATION ...</code> on the leader and <code>CREATE SUBSCRIBER ...</code> in the Cloud SQL instances) and synchronized the database in full to Cloud SQL.</p>
<p>On October 23, we took another 15-minute maintenance window to bring the site down again. We switched the website to the Cloud SQL databases during this maintenance window.</p>
<p>For the most part, this migration was a seamless experience for our users, but to achieve that, we had to spend weeks rehearsing and exploring the failure modes first. During our rehearsals and tests, we encountered many problems, such as broken database indexes or followers that couldn&#39;t synchronize with our new leader. We rebuilt our GCP self-hosted databases numerous times during these rehearsals after we tripped up on a new problem.</p>
<h2>Step 4: Move the Front-end</h2>
<p>We use the Cloudflare Load Balancer product to expand our capabilities to direct traffic to our servers. In the future, we will use this to make sure your web requests land on a server that&#39;s close to you, and we can use the load balancer to handle fallbacks in case of website outages.</p>
<p>However, the critical feature of the Cloudflare Load Balancer that we utilized for this migration is its controls to redirect requests to backends based on a percentage.</p>
<p>Typically, you might need to update DNS records and wait for the change to propagate to swap front-end servers. If anything goes wrong, you have to change the DNS record back and wait. We can reduce the delay by lowering the TTL of the DNS records in anticipation of the migration, but it is still a 0-100% rollout in a relatively short time window.</p>
<p>We pushed small percentages of production traffic (1-5%) to the new servers to verify them. While we were confident in the system, having spent time testing it (and dogfooding it ourselves), we still wanted to take care as we brought the rest of the world into the environment.</p>
<p>Once those were successful, we went from 5% to 100% Google Cloud - constantly eyeing the pager and our dashboards to make sure everything looked healthy along the way! We kept Heroku in our Cloudflare Load Balancer configuration to quickly bounce back if we discovered a major flaw, as one more safety net in the migration.</p>
<h2>Summary</h2>
<p>We migrated our website from Heroku to Google Cloud - a significant project requiring time to plan and practice to succeed. Does this sound like your kind of project? There&#39;s more where this came from, and <a href="https://replit.com/site/careers">we&#39;re hiring across many roles at Replit</a>!</p>
<p>In a future Part 2 of this blog post, we&#39;ll dig into the extra capabilities we gained from this migration - such as our new deployment system offering vast flexibility beyond a traditional blue/green deployment and performance improvements.</p>
