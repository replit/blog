<p>With many development tools and even whole development environments moving to the cloud, <a href="https://replit.com/">Replit</a> is at the forefront of this change.</p>
<p>Replit is one of the leading cloud, in-browser IDEs with support for fifty-plus programming languages with syntax highlighting and intelligent autocompletion.</p>
<p>However, Replit is more than just an IDE in a cloud. With additional features like real-time collaboration, GitHub integration, and detailed edit history, Replit is a full-blown workspace for teams, educators, and interviewers.</p>
<p>This guide will show you how to install <a href="https://mastodon.social/about">Mastodon</a> in the Replit environment, showing its versatility and potential.You can follow along with <a href="https://replit.com/@areknawo/Mastodon">this Repl</a>.</p>
<h2>What Is Mastodon?</h2>
<p>Before we start, let me introduce you to Mastodon: an open-source social networking software.</p>
<p><img src="https://imgur.com/qjrBwIt.png" alt="Mastodon"></p>
<p>Mastodon’s goal is to move social networking back into the hands of people. It’s an alternative to the likes of Twitter, focused primarily on microblogging. With anti-abuse tools, a feature-packed admin dashboard, and tons of social-networking features, Mastodon is an excellent choice for individual or business use.</p>
<p>On top of being open-source, Mastodon is built on open standards like <a href="https://docs.joinmastodon.org/spec/activitypub/">ActivityPub</a>, meaning there’s no lock-in. Thanks to such architecture, you can quickly transfer your data to other services supporting ActivityPub, if you ever choose to.</p>
<h2>Installing Mastodon in Replit</h2>
<p>Because Mastodon is a complex piece of software involving Redis, PostgreSQL, a Ruby backend, and a React frontend, installing it in a limited environment without root access, such as Replit, can be challenging. Thankfully, with recent updates, Replit <a href="https://blog.replit.com/nix">now allows you to run Nix</a>—a declarative, reproducible OS package manager—which makes running even the most complex apps on Replit possible.</p>
<h3>Creating Repl</h3>
<p>If you haven’t already, first <a href="https://replit.com/signup">create a Replit account</a>. Then, start by creating a new Nix Repl.</p>
<p><img src="https://i.imgur.com/RdLRavr.png" alt="Creating New Repl"></p>
<p>Two notes here:</p>
<ul>
<li>Although relatively stable, Nix support is still in beta, meaning you might encounter some unexpected issues.</li>
<li>Mastodon installation is a resource-heavy process. It’s possible that during installation, a free Repl instance will run out of memory. Because of that, if you intend to play with Mastodon in Replit, it’s recommended that you <a href="https://replit.com/site/pricing">upgrade to a paid plan</a> and even <a href="https://blog.replit.com/boosts">boost your Repl</a>.</li>
</ul>
<h3>Setting Up Config Files</h3>
<p>In your new Repl, you should see two important files: <code>.replit</code> and <code>replit.nix</code>.</p>
<p>The <code>.replit</code> file defines the run command (executed upon clicking <strong>Run</strong>) and environment variables. For now, configure it as follows:</p>
<pre><code class="language-text">run = &quot;sh start.sh&quot;

[env]
RAILS_ENV=&quot;development&quot;
</code></pre>
<p>The above config tells Replit to execute <code>start.sh</code> script on the <strong>Run</strong> action, and sets the <code>RAILS\_ENV</code> variable used by Mastodon to <code>“development”</code>, which is the mode it will run in.</p>
<p>The <code>replit.nix</code> file configures the Nix environment, like what packages to include.</p>
<pre><code class="language-text">{ pkgs }: {
    deps = [
        pkgs.ruby
        pkgs.postgresql
        pkgs.shared-mime-info
        pkgs.nodejs
        pkgs.yarn
        pkgs.imagemagick
        pkgs.ffmpeg
        pkgs.libpqxx
        pkgs.libxml2
        pkgs.libxslt
        pkgs.file
        pkgs.git
        pkgs.gpp
        pkgs.protobuf
        pkgs.pkg-config
        pkgs.gcc
        pkgs.autoconf
        pkgs.bison
        pkgs.openssl
        pkgs.libyaml
        pkgs.readline
        pkgs.zlib
        pkgs.ncurses
        pkgs.libffi
        pkgs.gdbm
        pkgs.redis
        pkgs.certbot
        pkgs.libidn
        pkgs.icu
        pkgs.jemalloc
    ];
}
</code></pre>
<p>The config is an anonymous function, taking <code>pkgs</code> as a parameter and returning a list of packages to be included. Above, I already defined most of the packages required by Mastodon.</p>
<p><code>shared-mime-info</code> is a package required by one of Mastodon’s dependencies. With that said, the dependency <a href="https://github.com/mimemagicrb/mimemagic/issues/160">can’t correctly detect the necessary package files</a>. To resolve this issue, you’ll have to <a href="https://cgit.freedesktop.org/xdg/shared-mime-info/tree/freedesktop.org.xml.in?h=Release-1-9">download the required file</a> directly and place it at the root of your Repl. After that, set a <code>FREEDESKTOP\_MIME\_TYPES\_PATH</code> env variable in the <code>.replit</code> file to let the dependency know how to find it.</p>
<pre><code class="language-text">[env]
RAILS_ENV=&quot;development&quot;
FREEDESKTOP_MIME_TYPES_PATH=&quot;/home/runner/${REPL_SLUG}/freedesktop.org.xml&quot;
</code></pre>
<p>Above, <code>REPL\_SLUG</code> is a variable identifying your Repl’s slug and therefore folder name in the file system.</p>
<h3>Installing Databases</h3>
<p>Redis and Postgres are already included in the package list. However, to make them work properly without root access, you’ll need to configure some of their options.</p>
<p>To run Redis, put the following command in your <code>start.sh</code> script:</p>
<pre><code class="language-bash"># start Redis
redis-cli shutdown
redis-server --bind 127.0.0.1 &amp;
</code></pre>
<p>The <code>\--bind</code> parameter lets the Redis server know that it should listen to the requests coming only from the selected address. This will allow Replit to proxy your future NGINX setup to its preview URL without Redis taking over.</p>
<p>Postgres is a bit more complicated. To set it up, first, you’ll need to create a few folders and files inside your Repl:</p>
<ul>
<li><code>data</code>. Directory for storing Postgres databases</li>
<li><code>postgres</code>. Directory for storing Postgres socket details</li>
<li><code>postgresql.conf.tpl</code>. Template file for providing Postgres configuration for later use</li>
</ul>
<p>The <code>postgresql.conf.tpl</code> should look as follows:</p>
<pre><code class="language-text">listen_addresses = &#39;127.0.0.1&#39;
port = 5432
unix_socket_directories = &#39;replace_unix_dir&#39;
</code></pre>
<p>In <code>.replit</code>, define two additional env variables to point Postgres to created directories. <code>PGDATA</code> sets Postgres data location, while <code>DB\_HOST</code> informs Mastodon where to look for the Postgres instance, as it’s not the default location.</p>
<pre><code class="language-text">PGDATA = &quot;/home/runner/${REPL_SLUG}/data&quot;
DB_HOST=&quot;/home/runner/${REPL_SLUG}/postgres&quot;
</code></pre>
<p>Finally, in the <code>start.sh</code> right under Redis setup:</p>
<pre><code class="language-bash"># start Postgres
pg_ctl stop

initdb -E UTF8
cp postgresql.conf.tpl data/postgresql.conf

socker_dir=&quot;\/home\/runner\/${REPL_SLUG}\/postgres&quot;

sed -i &quot;s/replace_unix_dir/${socker_dir}/&quot; data/postgresql.conf

pg_ctl -l /home/runner/${REPL_SLUG}/postgresql.log start
</code></pre>
<p>The above script:</p>
<ol>
<li>Stops any running Postgres instances.</li>
<li>Initializes Postgres database with UTF8 encoding (required for Mastodon).</li>
<li>Copies the configuration template to its destination.</li>
<li>Uses <code>sed</code> to fill in required <code>unix\_socket\_directories</code> value.</li>
<li>Sets log file location and starts the database.</li>
</ol>
<p>With the above changes in configuration files and directories, Postgres should run in Replit without issues.</p>
<h3>Installing NGINX</h3>
<p>Setting up NGINX is similar to the Postgres process. Start by creating the following files and directories:</p>
<ul>
<li><code>cache</code>. Directory for storing NGINX cache files</li>
<li><code>logs</code>. Directory for storing NGINX log files</li>
<li><code>mime.types</code>. File defining MIME types used by NGINX (<a href="https://github.com/nginx/nginx/blob/master/conf/mime.types">content available in NGINX’s GitHub repo</a>)</li>
<li><code>nginx.conf</code>. NGINX configuration file</li>
</ul>
<p>In <code>nginx.conf</code>, set the logs folder to the one created before, set <code>server\_name</code> to match your Replit URL (fill in <code>\[REPL\_SLUG\]</code> and <code>\[USER\_SLUG\]</code> placeholders), and configure NGINX to proxy requests to host <code>0.0.0.0</code> (required for Replit to proxy traffic) and port <code>3000</code> (default one for Mastodon).</p>
<pre><code class="language-text">worker_processes  1;

pid        /home/runner/Mastodon/logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log  /home/runner/Mastodon/logs/access.log;

    sendfile        on;

    keepalive_timeout  65;

    server {
        listen       8080;
        server_name  [REPL_SLUG].[USER_SLUG].repl.co;

        location / {
            proxy_set_header Host $http_host;
            proxy_pass   http://0.0.0.0:3000;
        }
    }

}
</code></pre>
<p>With this done, you’ll need to get back to <code>replit.nix</code> and include NGINX in the package list. However, it will require some additional configuration.</p>
<pre><code class="language-text">{ pkgs }: 
let nginxModified = pkgs.nginx.overrideAttrs (oldAttrs: rec {
        configureFlags = oldAttrs.configureFlags ++ [
            &quot;--http-client-body-temp-path=/home/runner/Mastodon/cache/client_body&quot;
            &quot;--http-proxy-temp-path=/home/runner/Mastodon/cache/proxy&quot;
            &quot;--http-fastcgi-temp-path=/home/runner/Mastodon/cache/fastcgi&quot;
            &quot;--http-uwsgi-temp-path=/home/runner/Mastodon/cache/uwsgi&quot;
            &quot;--http-scgi-temp-path=/home/runner/Mastodon/cache/scgi&quot;
         ];
    });

in {
    deps = [
        nginxModified
        # ...
    ];

}
</code></pre>
<p>Your config function should now look similar to the previous code. The <code>let</code> keyword defines a local <code>nginxModified</code> variable containing the base NGINX package, configured with necessary flags. Other dependencies remain untouched under the <code>deps</code> list.</p>
<p>Finally, in the <code>start.sh</code>—after all database setup commands—kill any running NGINX processes and start a new one with error logs location and config file properly set.</p>
<pre><code class="language-bash"># start Nginx
pkill nginx

nginx -e /home/runner/$REPL_SLUG/logs/error.log -c /home/runner/$REPL_SLUG/nginx.conf
</code></pre>
<h3>Installing Mastodon</h3>
<p>With all the packages successfully set up, you can now download, configure, and install Mastodon. Start by downloading <a href="https://github.com/mastodon/mastodon">Mastodon from its GitHub repo</a>.</p>
<pre><code class="language-bash">git clone https://github.com/mastodon/mastodon.git live &amp;&amp; cd live
git checkout $(git tag -l | grep -v &#39;rc[0-9]*$&#39; | sort -V | tail -n 1)
</code></pre>
<p>To run the above commands, open Replit Shell (either through a visible tab or <strong>Cmd/Ctrl + K</strong> and typing <code>Open Shell</code>.</p>
<p><img src="https://i.imgur.com/arkHNdP.png" alt="Replit Shell"></p>
<p>To allow access to Mastodon through Replit URL in <code>live/config/environments/development.rb</code>, add the following line:</p>
<pre><code class="language-ruby">Rails.application.configure do
  # ...
  # Allow Replit hosts
  config.hosts &lt;&lt; &#39;.repl.co&#39;
  #...
</code></pre>
<p>This will allow any URL ending with <code>.repl.co</code> to access Mastodon.</p>
<p>Lastly, add the following commands to <code>start.sh</code> to install dependencies, create a database schema, and run the Mastodon server.</p>
<pre><code class="language-bash">cd live
bundle config with &#39;development&#39;
bundle install
yarn install --pure-lockfile
bundle exec rails db:setup
bundle exec rails server &amp; ./bin/webpack-dev-server
</code></pre>
<p>After you click <strong>Run</strong>, the script might take a while to execute. In the end, an HTTP preview should pop up, but due to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a> (CSP) restrictions, it won’t display any content. To get around that, click <strong>Open in a new tab</strong>, and your Mastodon instance should be now up and running!</p>
<p><img src="https://i.imgur.com/mqQlGyR.png" alt="Mastodon running on Replit"></p>
<h2>Conclusion</h2>
<p>In this guide, you’ve learned how to install Mastodon in <a href="https://replit.com/">Replit</a>’s new Nix environment. Hopefully, this experience has shown you the potential of Replit and will inspire you to use the platform to create and run even more ambitious projects.</p>
