{"_id":"post-c5101261-2467-42d8-9a9c-cc490b059c6b","_type":"post","title":"Faster Nix Repl Startup","slug":{"_type":"slug","current":"nix-perf-improvements"},"body":[{"_key":"bcdca43d8b3a","children":[{"_type":"span","marks":[],"text":"For the past few months we have been working on improving our ","_key":"bcdca43d8b3a0"},{"_type":"span","marks":["b03ec9a22c44"],"text":"Nix integration","_key":"bcdca43d8b3a1"},{"_type":"span","marks":[],"text":". Nix allows users to easily use ","_key":"bcdca43d8b3a2"},{"_type":"span","marks":["bd6ad43968fc"],"text":"over 80,000 Linux packages","_key":"bcdca43d8b3a3"},{"_type":"span","marks":[],"text":" in a repl. Nix opens the door to many exciting tools and applications on the platform. Our goal is for every repl to be backed by Nix. Before we can do that, we need to ensure that the Nix experience is just as good, if not better, than our existing ","_key":"bcdca43d8b3a4"},{"_type":"span","marks":["c494bdf9267e"],"text":"Polygott","_key":"bcdca43d8b3a5"},{"_type":"span","marks":[],"text":" ","_key":"bcdca43d8b3a6"},{"_type":"span","marks":["ac60046c4520"],"text":"solution","_key":"bcdca43d8b3a7"},{"_type":"span","marks":[],"text":".","_key":"bcdca43d8b3a8"}],"markDefs":[{"_key":"b03ec9a22c44","_type":"link","href":"https://blog.replit.com/nix"},{"_key":"bd6ad43968fc","_type":"link","href":"https://search.nixos.org/packages"},{"_key":"c494bdf9267e","_type":"link","href":"https://github.com/replit/Polygott"},{"_key":"ac60046c4520","_type":"link","href":"https://blog.replit.com/elisp"}],"_type":"block","style":"normal"},{"_key":"f16b6b68b43c","children":[{"_type":"span","marks":[],"text":"If you've used a Nix repl, you may have noticed additional loading time when opening your repl. The console would show \"Loading Nix environment...\" and you'd have to wait for a few seconds. In some cases, you might have waited for tens of seconds. We care about making repls start up as fast as possible and this additional loading time wasn't acceptable.","_key":"f16b6b68b43c0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"39a88f0615df","children":[{"_type":"span","marks":[],"text":"Through some additional caching, we have entirely removed this loading time on many Nix repls. Now, Nix repls will start up just as fast as Polygott-based repls. See below for a before and after demonstration.","_key":"39a88f0615df0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"6f5f252648ac","children":[{"_type":"span","marks":[],"text":"Before:","_key":"6f5f252648ac0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"9fb782c5055d","children":[{"_type":"span","marks":[],"text":"After:","_key":"9fb782c5055d0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"e790d337e4b4","children":[{"_type":"span","marks":[],"text":"With this improvement, we are even closer to being able to transition all repls to Nix without causing any regressions in performance and usability. Stay tuned for more information about our migration plan to Nix.","_key":"e790d337e4b40"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"b137866e0392","children":[{"_type":"span","marks":[],"text":"Under The Hood","_key":"b137866e03920"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"83f7f090baf4","children":[{"_type":"span","marks":[],"text":"Before diving into the optimization, you'll need some information about how the Nix integration works.","_key":"83f7f090baf40"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"2bf5f35dd8e3","children":[{"_type":"span","marks":[],"text":"If you're unfamiliar with Nix, there's a couple important details you'll need to know. First, Nix uses a purely functional language for writing configuration and build steps for a package or environment. Second, all outputs (e.g. built binaries) are stored in the Nix store which is usually located at ","_key":"2bf5f35dd8e30"},{"_type":"span","marks":["code"],"text":"/nix/store","_key":"2bf5f35dd8e31"},{"_type":"span","marks":[],"text":".","_key":"2bf5f35dd8e32"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"0b5af405254e","children":[{"_type":"span","marks":[],"text":"When Nix evaluates the Nix expressions it generates build steps for each package which the Nix builder will execute. Concretely, Nix exports a set of environment variables and a build script to build a package. The builder script will place outputs in a directory in the Nix store.","_key":"0b5af405254e0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"ae70080ec336","children":[{"_type":"span","marks":[],"text":"We provide a seeded Nix store to each repl; this seeded Nix store includes a vast majority of packages in the ","_key":"ae70080ec3360"},{"_type":"span","marks":["8788953a1412"],"text":"nixpkgs","_key":"ae70080ec3361"},{"_type":"span","marks":[],"text":" repository.","_key":"ae70080ec3362"}],"markDefs":[{"_key":"8788953a1412","_type":"link","href":"https://github.com/NixOS/nixpkgs"}],"_type":"block","style":"normal"},{"_key":"0a4626e2a373","children":[{"_type":"span","marks":[],"text":"Just because a package is in the Nix store, that is, present in the ","_key":"0a4626e2a3730"},{"_type":"span","marks":["code"],"text":"/nix/store","_key":"0a4626e2a3731"},{"_type":"span","marks":[],"text":" directory, does not mean the package is available in your environment. This is usually done by adding each package to the ","_key":"0a4626e2a3732"},{"_type":"span","marks":["code"],"text":"PATH","_key":"0a4626e2a3733"},{"_type":"span","marks":[],"text":" environment variable.","_key":"0a4626e2a3734"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"c059425cb048","children":[{"_type":"span","marks":[],"text":"We can use ","_key":"c059425cb0480"},{"_type":"span","marks":["code"],"text":"nix-shell","_key":"c059425cb0481"},{"_type":"span","marks":[],"text":" to pop us into an environment where all these environment variables, like ","_key":"c059425cb0482"},{"_type":"span","marks":["code"],"text":"PATH","_key":"c059425cb0483"},{"_type":"span","marks":[],"text":" are populated with packages specified in the Nix expression. By default, a repl will automatically evaluate the Nix expression inside the ","_key":"c059425cb0484"},{"_type":"span","marks":["code"],"text":"replit.nix","_key":"c059425cb0485"},{"_type":"span","marks":[],"text":" file. The environment variables are then exported and stitched into the repl's environment variables used in the console, shell, etc...","_key":"c059425cb0486"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"fd4e8a5fe0ec","children":[{"_type":"span","marks":[],"text":"For example, Nix will generate a ","_key":"fd4e8a5fe0ec0"},{"_type":"span","marks":["code"],"text":"PATH","_key":"fd4e8a5fe0ec1"},{"_type":"span","marks":[],"text":" environment variable that looks something like this:","_key":"fd4e8a5fe0ec2"}],"markDefs":[],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"> echo $PATH\n/nix/store/w07a7k61dw5gnsyxj3kgcq3shr76jax8-bash-interactive-4.4-p23/bin:/nix/store/435paza0j48aa9vgvf6r2l12nrg4ld11-patchelf-0.12/bin:/nix/store/4xs1xyj8728yvh9y5v6ji819kwgfy2fv-gcc-wrapper-10.3.0/bin:[collapsed for berevity]:/home/runner/.nix-profile/bin:/home/runner/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n","_key":"7ae44350f669"},{"_key":"995a813172e4","children":[{"_type":"span","marks":[],"text":"Previously, every time a repl would start up, we would execute Nix to evaluate ","_key":"995a813172e40"},{"_type":"span","marks":["code"],"text":"replit.nix","_key":"995a813172e41"},{"_type":"span","marks":[],"text":" and export environment variables. Unfortunately, this was adding seconds to 10s of seconds to repl start up time.","_key":"995a813172e42"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"7d3d12275d6d","children":[{"_type":"span","marks":[],"text":"Luckily, due to the seeded Nix store, this operation usually doesn't add any new packages to the Nix store. This means that we can reuse the same set of environment variables between repl restarts.","_key":"7d3d12275d6d0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"d47230122d0e","children":[{"_type":"span","marks":[],"text":"Now we can get to the latest optimization. We persist the environment variables exported by ","_key":"d47230122d0e0"},{"_type":"span","marks":["code"],"text":"nix-shell","_key":"d47230122d0e1"},{"_type":"span","marks":[],"text":" to the repl's filesystem so you can skip the Nix evaulation step when your repl starts up.","_key":"d47230122d0e2"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"f3b88c076f84","children":[{"_type":"span","marks":[],"text":"There are some cases where the user's ","_key":"f3b88c076f840"},{"_type":"span","marks":["code"],"text":"replit.nix","_key":"f3b88c076f841"},{"_type":"span","marks":[],"text":" may add some new packages to the Nix store. In these cases, the cached environment variables are considered invalid if any cached environment variables contain references to Nix store paths that don't exist. In this case, the environment is rebuilt like before and you won't see any improvement from this additional caching layer, but we ensure you still get the correct environment for your repl.","_key":"f3b88c076f842"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"7ff4f42a56d5","children":[{"_type":"span","marks":[],"text":"In summary, caching environment variables from ","_key":"7ff4f42a56d50"},{"_type":"span","marks":["code"],"text":"nix-shell","_key":"7ff4f42a56d51"},{"_type":"span","marks":[],"text":" in the repl's filesystem removes the need to evaluate ","_key":"7ff4f42a56d52"},{"_type":"span","marks":["code"],"text":"replit.nix","_key":"7ff4f42a56d53"},{"_type":"span","marks":[],"text":" on repl startup in many cases. This additional caching reduces repl startup time by seconds to 10s of seconds.","_key":"7ff4f42a56d54"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"78e234a671a5","children":[{"_type":"span","marks":[],"text":"If you're interested in solving these kinds of challenges, come work with us! Check out our ","_key":"78e234a671a50"},{"_type":"span","marks":["254d05242822"],"text":"open positions","_key":"78e234a671a51"},{"_type":"span","marks":[],"text":".","_key":"78e234a671a52"}],"markDefs":[{"_key":"254d05242822","_type":"link","href":"https://replit.com/site/careers"}],"_type":"block","style":"normal"}],"publishedAt":"2021-10-13T00:00:00.000Z"}