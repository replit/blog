{"_id":"post-427adcfd-20a6-4365-b43a-82758cb56b40","_type":"post","title":"Infinite Loops","slug":{"_type":"slug","current":"infinite-loops"},"body":[{"_key":"173bd660162d","children":[{"_type":"span","marks":[],"text":"At Repl.it we aim to make the full power of programming easily accessible for everyone. That's why when we designed our ","_key":"173bd660162d0"},{"_type":"span","marks":["3ac9887baeb2"],"text":"code execution service","_key":"173bd660162d1"},{"_type":"span","marks":[],"text":" we decided that we would not timebox users' programs or sessions. [](preview end)","_key":"173bd660162d2"}],"markDefs":[{"_key":"3ac9887baeb2","_type":"link","href":"/api"}],"_type":"block","style":"normal"},{"_key":"69036ec0f688","children":[{"_type":"span","marks":[],"text":"This was a great design decision because it allowed people to build complex programs, things like infinite looping animations, and games -- like this ","_key":"69036ec0f6880"},{"_type":"span","marks":["0a2e74255518"],"text":"fun text-based game","_key":"69036ec0f6881"},{"_type":"span","marks":[],"text":":","_key":"69036ec0f6882"}],"markDefs":[{"_key":"0a2e74255518","_type":"link","href":"https://repl.it/BybT/6"}],"_type":"block","style":"normal"},{"_key":"8a2e4cdf3e55","children":[{"_type":"span","_key":"8a2e4cdf3e550","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"f5d5c112e979","children":[{"_type":"span","marks":[],"text":"But this also meant you could hit infinite loops. And in most cases this was okay because you can hit stop and we'd kill the program for you. Except this failed in two cases:","_key":"f5d5c112e9790"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"080451f295a5","children":[{"_type":"span","marks":[],"text":"If the program was sending so much output data to your browser that it was causing it lock up.","_key":"080451f295a50"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"d488dde6509b","children":[{"_type":"span","marks":[],"text":"If the program was running in your browser (as the case is with the JavaScript languages we support).","_key":"d488dde6509b0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"5447a447d807","children":[{"_type":"span","marks":["strong"],"text":"[tl;dr]","_key":"5447a447d8070"},{"_type":"span","marks":[],"text":" You'll be pleased to know that we fixed these two instances as well and -- as always -- here are some gifs to demonstrate, followed by a technical explanation for the curious.","_key":"5447a447d8071"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"37ed7fb1e5ea","children":[{"_type":"span","marks":["em"],"text":"Infinite hello world in python","_key":"37ed7fb1e5ea0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"0c444ede4492","children":[{"_type":"span","_key":"0c444ede44920","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"877de823229e","children":[{"_type":"span","marks":["em"],"text":"Infinite loop in JavaScript","_key":"877de823229e0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"23bfd9d86a88","children":[{"_type":"span","marks":[],"text":"Browser crashing from too much output","_key":"23bfd9d86a880"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"64a5ab63f91f","children":[{"_type":"span","marks":[],"text":"Because we want to enable interactive programs like the text-based game mentioned above we have to stream output from user programs directly to the browser. To do this we first start user programs in tty-mode (we make the program think that it's attached to a terminal), more specifically, we attach a ","_key":"64a5ab63f91f0"},{"_type":"span","marks":["28db093691fc"],"text":"pseudo-terminal (pty)","_key":"64a5ab63f91f1"},{"_type":"span","marks":[],"text":". However, ptys also adds additional functionality that we don't need. For example it outputs (echos) every input given to it which is useful for regular terminals but not for us since we want to control the user experience on the client-side.","_key":"64a5ab63f91f2"}],"markDefs":[{"_key":"28db093691fc","_type":"link","href":"http://man7.org/linux/man-pages/man7/pty.7.html"}],"_type":"block","style":"normal"},{"_key":"4836d724c7ad","children":[{"_type":"span","marks":[],"text":"To make a pty as pipe-like as possible (i.e. raw i/o) then we can use the following C program which uses the builtin linux ","_key":"4836d724c7ad0"},{"_type":"span","marks":["8b2fb3700c81"],"text":"termios API","_key":"4836d724c7ad1"},{"_type":"span","marks":[],"text":":","_key":"4836d724c7ad2"}],"markDefs":[{"_key":"8b2fb3700c81","_type":"link","href":"http://man7.org/linux/man-pages/man3/termios.3.html"}],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"#include <termios.h>\n\nint makeraw(int fd) {\n  struct termios tp;\n  if (tcgetattr(fd, &tp) == -1) {\n    return 1;\n  }\n  cfmakeraw(&tp);\n  if (tcsetattr(fd, TCSAFLUSH, &tp) == -1) {\n    return 1;\n  }\n  return 0;\n}\n","_key":"f563dd9b9c78"},{"_key":"a6905f15c5b9","children":[{"_type":"span","marks":[],"text":"Now that we've made sure that user programs stream perfectly to the client-side we need to make sure we don't crash the browser by overloading it. This is taken care by our frontend servers written in Go. What we do is make sure that we don't send output to the browser at a rate that exceeds 20 messages per second. We came up with this number via trial and error while making sure we don't cripple any existing use case (like say, animations or games).","_key":"a6905f15c5b90"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"356b620d0125","children":[{"_type":"span","marks":[],"text":"Luckily, Go has primitives that makes this sort of thing easy. The following is the actual goroutine we use to periodically flush the output buffer.","_key":"356b620d01250"}],"markDefs":[],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":" flushTicker := time.NewTicker(time.Second / 20)\n go func() {\n   for {\n     <-flushTicker.C\n\n     if done {\n       flushTicker.Stop()\n       return\n     }\n\n     if outputBuf.Len() > 0 {\n       flush()\n     }\n   }\n }()\n","_key":"8dd1a896bc1a"},{"_key":"2102c9fa925b","children":[{"_type":"span","marks":[],"text":"With this, users will likely not see their browser lock up if they hit an infinite loop that includes output.","_key":"2102c9fa925b0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"b6d417c69477","children":[{"_type":"span","marks":[],"text":"Browser locking up from infinite loops in JavaScript","_key":"b6d417c694770"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"192a55e8c964","children":[{"_type":"span","marks":[],"text":"We run most of our languages on our ","_key":"192a55e8c9640"},{"_type":"span","marks":["1d871de2f003"],"text":"code execution infrastructure","_key":"192a55e8c9641"},{"_type":"span","marks":[],"text":". However, in order to gain access to browser APIs, JavaScript (and compile-to-js) languages need to run on the user's browser. This presents many interesting challenges, one of which, is protecting the user from locking up the browser from infinite loops. This can happen because the UI and the JavaScript running on the page all run in the same single thread (taking turns).","_key":"192a55e8c9642"}],"markDefs":[{"_key":"1d871de2f003","_type":"link","href":"https://repl.it/api"}],"_type":"block","style":"normal"},{"_key":"54c10cd7f12c","children":[{"_type":"span","marks":[],"text":"The first thought that may come to your mind is \"run it in a worker!\" -- which is a web standard that allows us to start a background process and interact with it via message passing -- and this works perfectly fine to protect against locking up the browser. But now we're back at square one -- we don't have access to all the browser APIs that people want to use.","_key":"54c10cd7f12c0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"62c75fe31fc5","children":[{"_type":"span","marks":[],"text":"So the only other solution that we've seen used on ","_key":"62c75fe31fc50"},{"_type":"span","marks":["3e8f6f8c4815"],"text":"JSBin","_key":"62c75fe31fc51"},{"_type":"span","marks":[],"text":" is to transform the JavaScript code to add time or iteration counters to protect against infinite loops. The problem with this solution (as of this writing) is that it hits a couple of edgecases. Like for example the following code (which is, by the way, adapted from an actual user code that we saw) will halt with an infinite loop error:","_key":"62c75fe31fc52"}],"markDefs":[{"_key":"3e8f6f8c4815","_type":"link","href":"https://jsbin.com"}],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"var a;\ndo {\n a = prompt('hello')\n console.log(a);\n} while (a !== 'quit');\n","_key":"9b82e22ce38e"},{"_key":"fa1b5eb21ff6","children":[{"_type":"span","marks":[],"text":"Another edgecase that we wanted to protect against was an async infinite loop (which should be fine, because it yields to the event loop and doesn't lock up the browser):","_key":"fa1b5eb21ff60"}],"markDefs":[],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"function *x() {\n  while (true) yield 1;\n}\n\nvar g = x();\nconsole.log(g.next());\n\n// Should not think that it's been running non stop for a second\nsetTimeout(() => {\n  console.log(g.next());\n}, 1000);\n","_key":"9618b5e6692d"},{"_key":"dc6d0dc09b33","children":[{"_type":"span","marks":[],"text":"So we came up with the following set of heuristics to handle those edgecases. A loop will throw an error if the following was true:","_key":"dc6d0dc09b330"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"aac782241bfe","children":[{"_type":"span","marks":[],"text":"It happens in a single run (doesn't yield to the event loop)","_key":"aac782241bfe0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"3e015a258ac5","children":[{"_type":"span","marks":[],"text":"A high number of iterations","_key":"3e015a258ac50"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"932eb9892ca6","children":[{"_type":"span","marks":[],"text":"The loop is taking too long","_key":"932eb9892ca60"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"c8811a855423","children":[{"_type":"span","marks":[],"text":"We implemented this using ","_key":"c8811a8554230"},{"_type":"span","marks":["dca7a789c96c"],"text":"Babel","_key":"c8811a8554231"},{"_type":"span","marks":[],"text":" and leveraged it's ","_key":"c8811a8554232"},{"_type":"span","marks":["code"],"text":"retainLines","_key":"c8811a8554233"},{"_type":"span","marks":[],"text":" generator option to make sure that line numbers are reported correctly on errors.","_key":"c8811a8554234"}],"markDefs":[{"_key":"dca7a789c96c","_type":"link","href":"http://babeljs.io/"}],"_type":"block","style":"normal"},{"_key":"cf8f781307b8","children":[{"_type":"span","marks":[],"text":"If you're curious here is an adapted version of our Babel plugin which I think is pretty straightforward:","_key":"cf8f781307b80"}],"markDefs":[],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"'WhileStatement|ForStatement|DoWhileStatement': (path) => {\n  // A variable holding when the loop was started\n  const loopStart = path.scope.parent.generateUidIdentifier('loopStart');\n  const loopStartInit = dateNow();\n  path.scope.parent.push({\n    id: loopStart,\n    init: loopStartInit,\n  });\n\n  // An iterator that is incremented with each iteration\n  const iterator = path.scope.parent.generateUidIdentifier('loopIt');\n  const iteratorInit = t.numericLiteral(0);\n  path.scope.parent.push({\n    id: iterator,\n    init: iteratorInit,\n  });\n\n  // setTimeout to protect against breaking async and generator funcs.\n  path.insertBefore(\n    t.expressionStatement(\n      t.callExpression(\n        t.identifier('setTimeout'),\n        [t.functionExpression(\n          null,\n          [],\n          t.blockStatement([\n            t.expressionStatement(\n              t.assignmentExpression(\n                '=',\n                loopStart,\n                t.identifier('Infinity'),\n              ),\n            ),\n          ]),\n        )],\n      ),\n    ),\n  );\n\n  // If statement and throw error if it matches our criteria\n  const guard = t.ifStatement(\n    t.logicalExpression(\n      '&&',\n      t.binaryExpression(\n        '>',\n        t.updateExpression(\n          '++',\n          iterator,\n          true,\n        ),\n        t.numericLiteral(maxIteration),\n      ),\n      t.binaryExpression(\n        '>',\n        t.binaryExpression(\n          '-',\n          dateNow(),\n          loopStart,\n        ),\n        t.numericLiteral(maxLoopTimeMs),\n      ),\n    ),\n    t.throwStatement(\n      t.newExpression(\n        t.identifier('RangeError'),\n        [t.stringLiteral(\n          'Potential infinite loop. You can disable this from settings.',\n        )],\n      ),\n    ),\n  );\n\n  // No block statment e.g. `while (1) 1;`\n  if (!path.get('body').isBlockStatement()) {\n    const statement = path.get('body').node;\n    path.get('body').replaceWith(\n      t.blockStatement([\n        guard,\n        statement,\n      ]),\n    );\n  } else {\n    path.get('body').unshiftContainer('body', guard);\n  }\n}\n","_key":"9a5cca93386d"},{"_key":"67d11c915e58","children":[{"_type":"span","marks":[],"text":"Users can also turn this off from the settings. Let us know if we missed something or there is a better way to implement this. Hope you have infinite fun with this.","_key":"67d11c915e580"}],"markDefs":[],"_type":"block","style":"normal"}],"publishedAt":"2017-01-23T08:00:00.000Z"}