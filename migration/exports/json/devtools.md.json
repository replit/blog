{"_id":"post-26e6ee42-8b56-49ba-898d-cff1db1ca2eb","_type":"post","title":"Inspect your HTML/CSS/JS Repls with native DevTools","slug":{"_type":"slug","current":"devtools"},"body":[{"_key":"feb9701cfe3d","children":[{"_type":"span","marks":[],"text":"We recently launched a new Replit-native way to inspect and debug web pages you build on Replit. Whether you're learning the basics or hosting a rich application, quickly being able to inspect the console and DOM is critical to your workflow.","_key":"feb9701cfe3d0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"595191cd569f","children":[{"_type":"span","marks":[],"text":"Browsers ship with developer tools (e.g. ","_key":"595191cd569f0"},{"_type":"span","marks":["bb0a2a0f3ae5"],"text":"Chrome","_key":"595191cd569f1"},{"_type":"span","marks":[],"text":"), but they have a few shortcomings when working on Replit:","_key":"595191cd569f2"}],"markDefs":[{"_key":"bb0a2a0f3ae5","_type":"link","href":"https://developer.chrome.com/docs/devtools/"}],"_type":"block","style":"normal"},{"_key":"0e668b4ab6b6","children":[{"_type":"span","marks":[],"text":"Inspecting the nested webview iframe using browser DevTools can be complicated","_key":"0e668b4ab6b60"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"a4bab9398205","children":[{"_type":"span","marks":[],"text":"There are no solid solutions for developers working on mobile devices","_key":"a4bab93982050"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"07ea34722aa1","children":[{"_type":"span","marks":[],"text":"Some schools block access to browser DevTools","_key":"07ea34722aa10"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"6240ebcda9bf","children":[{"_type":"span","marks":[],"text":"Now all repls that show a webview have access to a Replit-native set of DevTools. Just click the wrench icon to bring it up:","_key":"6240ebcda9bf0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"62d3b7b0884c","children":[{"_type":"span","marks":[],"text":"You can access the console:","_key":"62d3b7b0884c0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"5ebd931323d2","children":[{"_type":"span","_key":"5ebd931323d20","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"affb4c641e40","children":[{"_type":"span","marks":[],"text":"Or inspect the DOM:","_key":"affb4c641e400"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"87655fd73476","children":[{"_type":"span","_key":"87655fd734760","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"0eaec2260049","children":[{"_type":"span","marks":[],"text":"And more.","_key":"0eaec22600490"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"8ce05f13a6a5","children":[{"_type":"span","marks":[],"text":"How we built it: Eruda","_key":"8ce05f13a6a50"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"17649eb58cf6","children":[{"_type":"span","marks":["e22c91da2547"],"text":"Eruda","_key":"17649eb58cf60"},{"_type":"span","marks":[],"text":" is the most complete, out-of-the-box solution that works great on mobile. At Replit, we love betting on cool open-source software projects, and we care deeply about supporting our ","_key":"17649eb58cf61"},{"_type":"span","marks":["8ff0aea25537"],"text":"mobile users","_key":"17649eb58cf62"},{"_type":"span","marks":[],"text":".","_key":"17649eb58cf63"}],"markDefs":[{"_key":"e22c91da2547","_type":"link","href":"https://github.com/liriliri/eruda"},{"_key":"8ff0aea25537","_type":"link","href":"https://blog.replit.com/mobile-v2"}],"_type":"block","style":"normal"},{"_key":"2291909e81a4","children":[{"_type":"span","marks":[],"text":"Eruda was a no brainer decision for us.","_key":"2291909e81a40"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"c03585ed8c57","children":[{"_type":"span","marks":[],"text":"Challenges: permissions, security, and timing","_key":"c03585ed8c570"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"44fc8bff9c1e","children":[{"_type":"span","marks":[],"text":"Permissions","_key":"44fc8bff9c1e0"}],"markDefs":[],"_type":"block","style":"h3"},{"_key":"bb4cef03519a","children":[{"_type":"span","marks":[],"text":"Browser DevTools run with higher privileges than the JavaScript loaded with the page. Notably, this allows the tools to inspect ","_key":"bb4cef03519a0"},{"_type":"span","marks":["em"],"text":"all","_key":"bb4cef03519a1"},{"_type":"span","marks":[],"text":" network traffic (images, video, etc.). While some are difficult, if not important, to inspect, others can be easily watched by spying on calls to ","_key":"bb4cef03519a2"},{"_type":"span","marks":["code"],"text":"window.XMLHttpRequest","_key":"bb4cef03519a3"},{"_type":"span","marks":[],"text":" and ","_key":"bb4cef03519a4"},{"_type":"span","marks":["code"],"text":"window.fetch","_key":"bb4cef03519a5"},{"_type":"span","marks":[],"text":".","_key":"bb4cef03519a6"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"0d4ce91c8c59","children":[{"_type":"span","marks":[],"text":"Eruda implemented an open source solution to this, ","_key":"0d4ce91c8c590"},{"_type":"span","marks":["6029169a998f"],"text":"chobitsu","_key":"0d4ce91c8c591"},{"_type":"span","marks":[],"text":", which is an implementation of the ","_key":"0d4ce91c8c592"},{"_type":"span","marks":["c3fa68abb50b"],"text":"Chrome DevTools protocol","_key":"0d4ce91c8c593"},{"_type":"span","marks":[],"text":" in JavaScript. The Chrome DevTools does not interact with the page directly but talks to an API that implements the protocol. Using a solution based on the Chrome DevTools protocol affords us maximal flexibility for future iterations.","_key":"0d4ce91c8c594"}],"markDefs":[{"_key":"6029169a998f","_type":"link","href":"https://github.com/liriliri/chobitsu"},{"_key":"c3fa68abb50b","_type":"link","href":"https://chromedevtools.github.io/devtools-protocol/"}],"_type":"block","style":"normal"},{"_key":"88b070f11a93","children":[{"_type":"span","marks":[],"text":"Security","_key":"88b070f11a930"}],"markDefs":[],"_type":"block","style":"h3"},{"_key":"307f11f04876","children":[{"_type":"span","marks":[],"text":"The nature of a DevTool requires us to have underlying access to the DOM, the ","_key":"307f11f048760"},{"_type":"span","marks":["code"],"text":"window","_key":"307f11f048761"},{"_type":"span","marks":[],"text":" object, cookies, and other resources that are only available if we comply with the ","_key":"307f11f048762"},{"_type":"span","marks":["92c26ce269e3"],"text":"same origin policy","_key":"307f11f048763"},{"_type":"span","marks":[],"text":". If you inspect the page, you'll notice we host devtools with the same origin as the repl itself within a ","_key":"307f11f048764"},{"_type":"span","marks":["em"],"text":"magic","_key":"307f11f048765"},{"_type":"span","marks":[],"text":" ","_key":"307f11f048766"},{"_type":"span","marks":["code"],"text":"__devtools_wrapper.html","_key":"307f11f048767"},{"_type":"span","marks":[],"text":" file. All Repls have this hidden file that serves as a wrapper page for business logic related to the DevTool, including its injection and toggling.","_key":"307f11f048768"}],"markDefs":[{"_key":"92c26ce269e3","_type":"link","href":"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy"}],"_type":"block","style":"normal"},{"_key":"2899ccaafe8c","children":[{"_type":"span","marks":[],"text":"Timing","_key":"2899ccaafe8c0"}],"markDefs":[],"_type":"block","style":"h3"},{"_key":"285867efaa8d","children":[{"_type":"span","marks":[],"text":"The greatest challenge we have had so far is ensuring the DevTools is not missing information it should have captured. We need to ensure our DevTools run before any JavaScript on the page, so we can correctly capture all events the user might need for debugging. For example, an error may be displayed on the ","_key":"285867efaa8d0"},{"_type":"span","marks":["code"],"text":"console","_key":"285867efaa8d1"},{"_type":"span","marks":[],"text":" before our tools load.","_key":"285867efaa8d2"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"48de32a41a8e","children":[{"_type":"span","marks":[],"text":"Our first attempt looked roughly like this:","_key":"48de32a41a8e0"}],"markDefs":[],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"<iframe src=\"/\"></iframe>\n<script src=\"devtools.js\"></script>\n","_key":"b5885772ede2"},{"_key":"dd3e8e93cbb3","children":[{"_type":"span","marks":[],"text":"By the time the devtools script kicks in, the iframe could have run some of its scripts. So we were missing some of the action.","_key":"dd3e8e93cbb30"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"4d71f5656f8a","children":[{"_type":"span","marks":[],"text":"Attempt two looked like this:","_key":"4d71f5656f8a0"}],"markDefs":[],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"<iframe id=\"iframe\"></iframe>\n<script>\n  iframe.src = \"/\";\n  // modify iframe here\n</script>\n","_key":"574feac9218a"},{"_key":"8f45661c47ab","children":[{"_type":"span","marks":[],"text":"The reference of ","_key":"8f45661c47ab0"},{"_type":"span","marks":["code"],"text":"iframe.contentWindow","_key":"8f45661c47ab1"},{"_type":"span","marks":[],"text":" will change after ","_key":"8f45661c47ab2"},{"_type":"span","marks":["code"],"text":"src","_key":"8f45661c47ab3"},{"_type":"span","marks":[],"text":" changes, and there is no way to know precisely when that happens. Modifying the ","_key":"8f45661c47ab4"},{"_type":"span","marks":["code"],"text":"contentWindow","_key":"8f45661c47ab5"},{"_type":"span","marks":[],"text":" at the wrong moment means we will be working with a disposed (and hence useless) ","_key":"8f45661c47ab6"},{"_type":"span","marks":["code"],"text":"window","_key":"8f45661c47ab7"},{"_type":"span","marks":[],"text":" object.","_key":"8f45661c47ab8"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"fb1b3df632f1","children":[{"_type":"span","marks":[],"text":"So we came up with attempt number three: we load an ","_key":"fb1b3df632f10"},{"_type":"span","marks":["code"],"text":"iframe","_key":"fb1b3df632f11"},{"_type":"span","marks":[],"text":" without ","_key":"fb1b3df632f12"},{"_type":"span","marks":["code"],"text":"src","_key":"fb1b3df632f13"},{"_type":"span","marks":[],"text":", then run.","_key":"fb1b3df632f14"}],"markDefs":[],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"const res = await fetch(\"/\");\nconst html = await res.text();\ninjectDevTools(html);\niframe.contentDocument.open();\niframe.contentDocument.write(html);\niframe.contentDocument.close();\n","_key":"02e6685971c9"},{"_key":"6794e19f85ab","children":[{"_type":"span","marks":[],"text":"This works pretty well for the initial page, but the DevTools disappear when the user navigates to another page. To fix this, we listen to the ","_key":"6794e19f85ab0"},{"_type":"span","marks":["code"],"text":"window","_key":"6794e19f85ab1"},{"_type":"span","marks":[],"text":" 's ","_key":"6794e19f85ab2"},{"_type":"span","marks":["code"],"text":"unload","_key":"6794e19f85ab3"},{"_type":"span","marks":[],"text":" event and run the logic above again for any navigation. The last bug we had is that ","_key":"6794e19f85ab4"},{"_type":"span","marks":["code"],"text":"location.reload","_key":"6794e19f85ab5"},{"_type":"span","marks":[],"text":" within the iframe breaks since the ","_key":"6794e19f85ab6"},{"_type":"span","marks":["code"],"text":"iframe","_key":"6794e19f85ab7"},{"_type":"span","marks":[],"text":" technically has no ","_key":"6794e19f85ab8"},{"_type":"span","marks":["code"],"text":"src","_key":"6794e19f85ab9"},{"_type":"span","marks":[],"text":", which was then fixed by adding a ","_key":"6794e19f85ab10"},{"_type":"span","marks":["code"],"text":"history.pushState","_key":"6794e19f85ab11"},{"_type":"span","marks":[],"text":" call on top.","_key":"6794e19f85ab12"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"bb6a548e5196","children":[{"_type":"span","marks":[],"text":"Try it out!","_key":"bb6a548e51960"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"98c59a5e9884","children":[{"_type":"span","marks":[],"text":"We hope you like the new Replit-native DevTools. We're really enjoying the experience when working in the webview, either on desktop or mobile.","_key":"98c59a5e98840"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"752395da57be","children":[{"_type":"span","marks":[],"text":"And if you enjoy hacking on frontend infrastructure (or other things...), consider ","_key":"752395da57be0"},{"_type":"span","marks":["187633aae771"],"text":"joining us","_key":"752395da57be1"},{"_type":"span","marks":[],"text":"!","_key":"752395da57be2"}],"markDefs":[{"_key":"187633aae771","_type":"link","href":"https://jobs.lever.co/replit/35f0e743-429c-4f60-ba07-8de9bbc8fffc"}],"_type":"block","style":"normal"}],"publishedAt":"2022-07-15T00:00:00.000Z"}