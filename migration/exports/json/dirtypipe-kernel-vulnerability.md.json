{"_id":"post-8a831316-9b9f-4e8d-85ff-136bbde4d351","_type":"post","title":"Escaping Dirty Pipe (a.k.a. CVE-2022-0847), mostly unscathed","slug":{"_type":"slug","current":"dirtypipe-kernel-vulnerability"},"body":[{"_key":"1e0314c66254","children":[{"_type":"span","marks":[],"text":"You may have heard that there was a very critical Linux kernel vulnerability making the rounds. As with all important enough vulnerabilities, this one has a catchy name: ","_key":"1e0314c662540"},{"_type":"span","marks":["1c802e28c8d7"],"text":"Dirty Pipe","_key":"1e0314c662541"},{"_type":"span","marks":[],"text":" (no logo, though). This blogpost attempts to explain how that vulnerability impacted Replit. The good news is that as far as we know, there weren't any successful exploitations of it!","_key":"1e0314c662542"}],"markDefs":[{"_key":"1c802e28c8d7","_type":"link","href":"https://dirtypipe.cm4all.com/"}],"_type":"block","style":"normal"},{"_key":"803e5b19e852","children":[{"_type":"span","marks":[],"text":"That article linked above has the full explanation and is definitely worth the read because it narrates the journey from discovery to fix. In case you're in a hurry, the short description of that vulnerability is that it allowed any user to temporarily overwrite ","_key":"803e5b19e8520"},{"_type":"span","marks":["em"],"text":"any","_key":"803e5b19e8521"},{"_type":"span","marks":[],"text":" file in the filesystem, without requiring any write permissions to do so. Temporarily because it didn't actually change the file, just the in-memory page cache, so if the kernel was under any sort of memory pressure, those changes would go away. There were a few more restrictions (mostly about the position, alignment, and length of the write), but other than that this allowed the attacker to make all sorts of very scary modifications to the system. Notably, the ","_key":"803e5b19e8522"},{"_type":"span","marks":["76ca487b5bb2"],"text":"proof-of-concept","_key":"803e5b19e8523"},{"_type":"span","marks":[],"text":" code allowed any user to open a root shell by overwriting a ","_key":"803e5b19e8524"},{"_type":"span","marks":["090daa473041"],"text":"setuid binary","_key":"803e5b19e8525"},{"_type":"span","marks":[],"text":" that had privileges to \"become\" root by the mere act of invoking it.","_key":"803e5b19e8526"}],"markDefs":[{"_key":"76ca487b5bb2","_type":"link","href":"https://dirtypipe.cm4all.com/#exploiting"},{"_key":"090daa473041","_type":"link","href":"https://en.wikipedia.org/wiki/Setuid"}],"_type":"block","style":"normal"},{"_key":"f58dee5e5bc3","children":[{"_type":"span","marks":[],"text":"The moment our \"security advocate\" (in reality it's just one of our platform engineers in a funny disguise until we ","_key":"f58dee5e5bc30"},{"_type":"span","marks":["2f4ff1ef0ec0"],"text":"hire a full-time security engineer","_key":"f58dee5e5bc31"},{"_type":"span","marks":[],"text":") realized that this was such a serious bug, we immediately tried the proof-of-concept code. And we were delighted that it didn't work! We very recently enabled the ","_key":"f58dee5e5bc32"},{"_type":"span","marks":["9425a84fd6e7","code"],"text":"no new privs","_key":"f58dee5e5bc33"},{"_type":"span","marks":["9425a84fd6e7"],"text":" bit","_key":"f58dee5e5bc34"},{"_type":"span","marks":[],"text":" that negated the effects of the setuid bit, so the user was greeted with a normal shell instead of a root shell. This meant that the scariest part of this exploit (escalation of privileges) was not possible in our system. Furthermore, the container has a very limited set of ","_key":"f58dee5e5bc35"},{"_type":"span","marks":["40bd842b7af9"],"text":"capabilities","_key":"f58dee5e5bc36"},{"_type":"span","marks":[],"text":", which meant that even if the root shell would have indeed been possible, the attacker would not have been able to make most changes to the system. Hooray for ","_key":"f58dee5e5bc37"},{"_type":"span","marks":["2958abae6144"],"text":"defense in depth","_key":"f58dee5e5bc38"},{"_type":"span","marks":[],"text":"!","_key":"f58dee5e5bc39"}],"markDefs":[{"_key":"2f4ff1ef0ec0","_type":"link","href":"https://jobs.lever.co/replit/6ed43742-5732-4235-b38c-35e2bdab9195"},{"_key":"9425a84fd6e7","_type":"link","href":"https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt"},{"_key":"40bd842b7af9","_type":"link","href":"https://man7.org/linux/man-pages/man7/capabilities.7.html"},{"_key":"2958abae6144","_type":"link","href":"https://en.wikipedia.org/wiki/Defense_in_depth_(computing)"}],"_type":"block","style":"normal"},{"_key":"5a2309f8d997","children":[{"_type":"span","marks":[],"text":"Our initial happiness quickly dissipated, though. Even if the proof-of-concept didn't quite work all the way, it still had an effect: the files were still rewritten. So what's the worse that an attacker could do with that newly found power? Since we use Linux containers (through Docker), that means that the files in the root filesystem are shared in read-only fashion among all the containers in a system. So ","_key":"5a2309f8d9970"},{"_type":"span","marks":["em"],"text":"what if","_key":"5a2309f8d9971"},{"_type":"span","marks":[],"text":" we tried to overwrite an important binary that everybody used (say, ","_key":"5a2309f8d9972"},{"_type":"span","marks":["code"],"text":"/bin/sh","_key":"5a2309f8d9973"},{"_type":"span","marks":[],"text":")? Turns out that the page cache is shared among containers too, so the modifications were visible to ","_key":"5a2309f8d9974"},{"_type":"span","marks":["em"],"text":"all","_key":"5a2309f8d9975"},{"_type":"span","marks":[],"text":" repls in that one machine! This means that if a malicious user wanted, they could have been able to surreptitiously make changes to the shell, which means that they could make any modifications to any repl that happened to be running in that same machine. Exfiltration of secrets, modification of files, anything. So we needed to patch this ","_key":"5a2309f8d9976"},{"_type":"span","marks":["em"],"text":"ASAP","_key":"5a2309f8d9977"},{"_type":"span","marks":[],"text":".","_key":"5a2309f8d9978"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"e11dc69b515c","children":[{"_type":"span","marks":[],"text":"Fortunately the kernel already had a patch available, so all we needed to do was to make a deployment and wait a bit. We got very lucky here, because this could be a very long battle to get mitigations in place, but the disclosure of this was well-coordinated. We were very happy that this moment was mostly anti-climactic.","_key":"e11dc69b515c0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"024ac0976190","children":[{"_type":"span","marks":[],"text":"By the way, if you tried to open any C# repl between 2022-03-09 and 2022-03-11, you might have seen a warning about a ","_key":"024ac09761900"},{"_type":"span","marks":["7bd35ff35ba3"],"text":"kernel bug","_key":"024ac09761901"},{"_type":"span","marks":[],"text":" preventing those repls from running. It turns out that it's a different, unrelated issue. Two different kernel bugs in the same week? What are the odds!? But that's a story for another day.","_key":"024ac09761902"}],"markDefs":[{"_key":"7bd35ff35ba3","_type":"link","href":"https://bugs.launchpad.net/ubuntu/+source/linux-signed-gcp-5.13/+bug/1964426"}],"_type":"block","style":"normal"},{"_key":"6e3302dc8728","children":[{"_type":"span","marks":[],"text":"Loved to read about these shenanigans? Interested to learn more? Want to be our full-time security engineer and help protect the next billion software creators? Consider applying, because we are ","_key":"6e3302dc87280"},{"_type":"span","marks":["bb2dfb9a608f"],"text":"hiring for all engineering roles!","_key":"6e3302dc87281"}],"markDefs":[{"_key":"bb2dfb9a608f","_type":"link","href":"https://replit.com/site/careers"}],"_type":"block","style":"normal"}],"publishedAt":"2022-03-16T18:00:00.000Z"}