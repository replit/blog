{"_id":"post-c991ee64-17af-491b-ad67-ccabd480b3ef","_type":"post","title":"Announcing File Persistence in Hosted Apps for Hackers","slug":{"_type":"slug","current":"replspace-filesystems"},"body":[{"_key":"39938d289cf1","children":[{"_type":"span","marks":[],"text":"We mostly think of repls as being full computers in the cloud, and one of the goals of the platform team at Replit is to enable people to build ","_key":"39938d289cf10"},{"_type":"span","marks":["em"],"text":"almost","_key":"39938d289cf11"},{"_type":"span","marks":[],"text":" anything in ","_key":"39938d289cf12"},{"_type":"span","marks":["a5912043bb66"],"text":"replspace","_key":"39938d289cf13"},{"_type":"span","marks":[],"text":". In the past, when a file was stored in a repl, it would only be saved when the editor was opened. This went against our goal and made it impossible to write certain servers that changed files at runtime. This was especially hard for newcomers, because that's the easiest way to persist information. Starting today, Hacker and Teams subscribers will be able to write services that accept file uploads or store data in a local database (think SQLite) or text file, regardless of how the repl was started.","_key":"39938d289cf14"}],"markDefs":[{"_key":"a5912043bb66","_type":"link","href":"#what-is-replspace"}],"_type":"block","style":"normal"},{"_key":"66af9fbd6969","children":[{"_type":"span","marks":[],"text":"Your browser does not support the video tag. But this was a very nice demo of what it looks like for a server to be able to save its files. A demo of what it looks like for a server to be able to save its files: ","_key":"66af9fbd69690"},{"_type":"span","marks":["7355963f1e19"],"text":"https://sqlite.luisreplit.repl.co","_key":"66af9fbd69691"}],"markDefs":[{"_key":"7355963f1e19","_type":"link","href":"https://sqlite.luisreplit.repl.co"}],"_type":"block","style":"normal"},{"_key":"f060437df44a","children":[{"_type":"span","marks":[],"text":"What is replspace?","_key":"f060437df44a0"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"39e1156871c1","children":[{"_type":"span","marks":[],"text":"replspace is a term we coined up. In operating systems, memory is divided into ","_key":"39e1156871c10"},{"_type":"span","marks":["em"],"text":"kernel space","_key":"39e1156871c11"},{"_type":"span","marks":[],"text":" and ","_key":"39e1156871c12"},{"_type":"span","marks":["em"],"text":"user space","_key":"39e1156871c13"},{"_type":"span","marks":[],"text":". ","_key":"39e1156871c14"},{"_type":"span","marks":["04239c67ec0f","em"],"text":"Kernel space","_key":"39e1156871c15"},{"_type":"span","marks":["04239c67ec0f"],"text":" is where the kernel executes and provides its services","_key":"39e1156871c16"},{"_type":"span","marks":[],"text":". The kernel can access ","_key":"39e1156871c17"},{"_type":"span","marks":["em"],"text":"all","_key":"39e1156871c18"},{"_type":"span","marks":[],"text":" of the memory, but the user cannot access the kernel's memory directly. By contrast, ","_key":"39e1156871c19"},{"_type":"span","marks":["em"],"text":"user space","_key":"39e1156871c110"},{"_type":"span","marks":[],"text":" is all the memory that a user can access without modifying the kernel sources (or creating a ","_key":"39e1156871c111"},{"_type":"span","marks":["ba448e0d3ca9"],"text":"kernel module","_key":"39e1156871c112"},{"_type":"span","marks":[],"text":"). The term ","_key":"39e1156871c113"},{"_type":"span","marks":["em"],"text":"user space","_key":"39e1156871c114"},{"_type":"span","marks":[],"text":" has also been used to refer to the programs that are run by users.","_key":"39e1156871c115"}],"markDefs":[{"_key":"04239c67ec0f","_type":"link","href":"http://www.linfo.org/kernel_space.html"},{"_key":"ba448e0d3ca9","_type":"link","href":"https://tldp.org/LDP/lkmpg/2.6/html/lkmpg.html#AEN40"}],"_type":"block","style":"normal"},{"_key":"04f4ff0ae0fa","children":[{"_type":"span","marks":[],"text":"This memory separation is important because the kernel manages all hardware resources, providing access control and coordination, and provides abstractions that let programs that run in ","_key":"04f4ff0ae0fa0"},{"_type":"span","marks":["em"],"text":"user space","_key":"04f4ff0ae0fa1"},{"_type":"span","marks":[],"text":" make requests to interact with those resources. The kernel has several interfaces so that the ","_key":"04f4ff0ae0fa2"},{"_type":"span","marks":["em"],"text":"user space","_key":"04f4ff0ae0fa3"},{"_type":"span","marks":[],"text":" programs can communicate with the kernel, the most important one being the ","_key":"04f4ff0ae0fa4"},{"_type":"span","marks":["d40c18e574a4","em"],"text":"system call interface","_key":"04f4ff0ae0fa5"},{"_type":"span","marks":[],"text":". These use the abstractions laid out by the kernel to ensure that users and programs don't interfere with each other and also iron out differences in the underlying hardware and provide a uniform \"view\" of the resources available to the machine.","_key":"04f4ff0ae0fa6"}],"markDefs":[{"_key":"d40c18e574a4","_type":"link","href":"https://en.wikipedia.org/wiki/Linux_kernel_interfaces"}],"_type":"block","style":"normal"},{"_key":"f14e036afc18","children":[{"_type":"span","_key":"f14e036afc180","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"0c13fbc33a7b","children":[{"_type":"span","marks":[],"text":"What is replspace, then? By analogy, replspace is all the memory that users of a repl can access, as well as the programs that can be run. In other words, ","_key":"0c13fbc33a7b0"},{"_type":"span","marks":["em"],"text":"anything","_key":"0c13fbc33a7b1"},{"_type":"span","marks":[],"text":" that a user of a repl can do is replspace!","_key":"0c13fbc33a7b2"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"d8d33d57763a","children":[{"_type":"span","marks":[],"text":"Tell me about the support for saving files now!","_key":"d8d33d57763a0"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"f96b22b43c1f","children":[{"_type":"span","marks":[],"text":"We have two ways in which we save users' files: ","_key":"f96b22b43c1f0"},{"_type":"span","marks":["7b32d5478fe0"],"text":"Operational Transformation history logs","_key":"f96b22b43c1f1"},{"_type":"span","marks":[],"text":" and ","_key":"f96b22b43c1f2"},{"_type":"span","marks":["a3ee81c4acbb","code"],"text":"btrfs","_key":"f96b22b43c1f3"},{"_type":"span","marks":["a3ee81c4acbb"],"text":" filesystem","_key":"f96b22b43c1f4"},{"_type":"span","marks":[],"text":" ","_key":"f96b22b43c1f5"},{"_type":"span","marks":["a0ba16ae0332"],"text":"snapshots","_key":"f96b22b43c1f6"},{"_type":"span","marks":[],"text":". Text files that are opened from the editor are saved with the former, which also provides nice collaboration capabilities. But non-text, binary files are not well supported by Operational Transformations, so we rely on saving the whole state of all the files through a feature of the ","_key":"f96b22b43c1f7"},{"_type":"span","marks":["code"],"text":"btrfs","_key":"f96b22b43c1f8"},{"_type":"span","marks":[],"text":" filesystem in Linux called ","_key":"f96b22b43c1f9"},{"_type":"span","marks":["7023d98237bd"],"text":"snapshots","_key":"f96b22b43c1f10"},{"_type":"span","marks":[],"text":".","_key":"f96b22b43c1f11"}],"markDefs":[{"_key":"7b32d5478fe0","_type":"link","href":"https://blog.replit.com/collab#protocol-changes--operational-transformation"},{"_key":"a3ee81c4acbb","_type":"link","href":"https://btrfs.wiki.kernel.org/index.php/Main_Page"},{"_key":"a0ba16ae0332","_type":"link","href":"https://blog.replit.com/data-loss"},{"_key":"7023d98237bd","_type":"link","href":"https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Snapshots"}],"_type":"block","style":"normal"},{"_key":"d2ac3600447c","children":[{"_type":"span","marks":[],"text":"There are a few tools at our disposal that we can use to know when files changed. The most commonly-used one is a kernel ","_key":"d2ac3600447c0"},{"_type":"span","marks":["em"],"text":"system call","_key":"d2ac3600447c1"},{"_type":"span","marks":[],"text":" named ","_key":"d2ac3600447c2"},{"_type":"span","marks":["1222e38566c1","code"],"text":"inotify","_key":"d2ac3600447c3"},{"_type":"span","marks":[],"text":", which lets users \"monitor filesystem events\" (changes to individual files, individual directories, or to files inside one directory). We use this feature to reload the new contents of the file in the editor after ","_key":"d2ac3600447c4"},{"_type":"span","marks":["99c494c9fb96"],"text":"formatting","_key":"d2ac3600447c5"},{"_type":"span","marks":[],"text":" a file, or to know when another user in a multiplayer session created or deleted a file. But this feature is not very scalable: since it can only detect changes ","_key":"d2ac3600447c6"},{"_type":"span","marks":["em"],"text":"in one directory","_key":"d2ac3600447c7"},{"_type":"span","marks":[],"text":" at a time, detecting that ","_key":"d2ac3600447c8"},{"_type":"span","marks":["em"],"text":"any","_key":"d2ac3600447c9"},{"_type":"span","marks":[],"text":" file in a repl changed would be very expensive! So for the longest time, we have had this weird flow of the editor telling the repl about what set of files and directories it cares about, the repl telling the editor that ","_key":"d2ac3600447c10"},{"_type":"span","marks":["em"],"text":"something","_key":"d2ac3600447c11"},{"_type":"span","marks":[],"text":" the editor cared about changed, and then relied on the editor to detect when things change and start a new snapshotting process. This is why a repl that was started as a server was not able to save any files: there was no editor connected to tell the repl to save a new snapshot!","_key":"d2ac3600447c12"}],"markDefs":[{"_key":"1222e38566c1","_type":"link","href":"https://man7.org/linux/man-pages/man7/inotify.7.html"},{"_key":"99c494c9fb96","_type":"link","href":"https://blog.replit.com/intel#formatting"}],"_type":"block","style":"normal"},{"_key":"c7cc318687d7","children":[{"_type":"span","marks":[],"text":"We currently use the ","_key":"c7cc318687d70"},{"_type":"span","marks":["beaa4763a047"],"text":"Long-Term Support version of Ubuntu Linux","_key":"c7cc318687d71"},{"_type":"span","marks":[],"text":". It very recently released version 20.04.3 LTS, which included the 5.11 Linux kernel. ","_key":"c7cc318687d72"},{"_type":"span","marks":["719e727030ed"],"text":"This","_key":"c7cc318687d73"},{"_type":"span","marks":[],"text":" ","_key":"c7cc318687d74"},{"_type":"span","marks":["2832fb941e54"],"text":"includes","_key":"c7cc318687d75"},{"_type":"span","marks":[],"text":" ","_key":"c7cc318687d76"},{"_type":"span","marks":["ecb46766b89c"],"text":"lots","_key":"c7cc318687d77"},{"_type":"span","marks":[],"text":" ","_key":"c7cc318687d78"},{"_type":"span","marks":["dfb382f62adb"],"text":"of","_key":"c7cc318687d79"},{"_type":"span","marks":[],"text":" ","_key":"c7cc318687d710"},{"_type":"span","marks":["e6833320f031"],"text":"very","_key":"c7cc318687d711"},{"_type":"span","marks":[],"text":" ","_key":"c7cc318687d712"},{"_type":"span","marks":["940645321fde"],"text":"cool","_key":"c7cc318687d713"},{"_type":"span","marks":[],"text":" ","_key":"c7cc318687d714"},{"_type":"span","marks":["97c48145d00c"],"text":"features","_key":"c7cc318687d715"},{"_type":"span","marks":[],"text":"! And buried inside the ","_key":"c7cc318687d716"},{"_type":"span","marks":["bd5351383029"],"text":"5.9","_key":"c7cc318687d717"},{"_type":"span","marks":[],"text":" release notes is a small change:","_key":"c7cc318687d718"}],"markDefs":[{"_key":"beaa4763a047","_type":"link","href":"https://ubuntu.com/about/release-cycle#ubuntu-kernel-release-cycle"},{"_key":"719e727030ed","_type":"link","href":"https://kernelnewbies.org/Linux_5.5"},{"_key":"2832fb941e54","_type":"link","href":"https://kernelnewbies.org/Linux_5.6"},{"_key":"ecb46766b89c","_type":"link","href":"https://kernelnewbies.org/Linux_5.7"},{"_key":"dfb382f62adb","_type":"link","href":"https://kernelnewbies.org/Linux_5.8"},{"_key":"e6833320f031","_type":"link","href":"https://kernelnewbies.org/Linux_5.9"},{"_key":"940645321fde","_type":"link","href":"https://kernelnewbies.org/Linux_5.10"},{"_key":"97c48145d00c","_type":"link","href":"https://kernelnewbies.org/Linux_5.11"},{"_key":"bd5351383029","_type":"link","href":"https://kernelnewbies.org/Linux_5.9"}],"_type":"block","style":"normal"},{"_key":"d2a9a602d049","children":[{"_type":"span","marks":["d7ae5551444e","code"],"text":"fanotify","_key":"d2a9a602d0490"},{"_type":"span","marks":[],"text":": report events with names. With these you can now efficiently monitor whole filesystems [...].","_key":"d2a9a602d0491"}],"markDefs":[{"_key":"d7ae5551444e","_type":"link","href":"https://man7.org/linux/man-pages/man7/fanotify.7.html"}],"_type":"block","style":"blockquote"},{"_key":"9dc8e446019e","children":[{"_type":"span","marks":[],"text":"And efficiently monitoring whole filesystems is ","_key":"9dc8e446019e0"},{"_type":"span","marks":["em"],"text":"exactly","_key":"9dc8e446019e1"},{"_type":"span","marks":[],"text":" what we needed to do in order to know when to save a new snapshot! Now we can stop having that weird repl-editor-repl flow and instead let the repl save a new snapshot every time it detects a new change to ","_key":"9dc8e446019e2"},{"_type":"span","marks":["em"],"text":"any","_key":"9dc8e446019e3"},{"_type":"span","marks":[],"text":" file inside the repl (with a little bit of delay to avoid saving ","_key":"9dc8e446019e4"},{"_type":"span","marks":["em"],"text":"too","_key":"9dc8e446019e5"},{"_type":"span","marks":[],"text":" often, like every time a new letter is typed in a file). The editor is no longer in the picture, so this behavior happens regardless of how the repl is started. Check out ","_key":"9dc8e446019e6"},{"_type":"span","marks":["975a6d5b388c"],"text":"a demo repl","_key":"9dc8e446019e7"},{"_type":"span","marks":[],"text":"!","_key":"9dc8e446019e8"}],"markDefs":[{"_key":"975a6d5b388c","_type":"link","href":"https://sqlite.luisreplit.repl.co"}],"_type":"block","style":"normal"},{"_key":"23c33fa61a84","children":[{"_type":"span","marks":[],"text":"Since repls run in a ","_key":"23c33fa61a840"},{"_type":"span","marks":["ad891e88a5fb"],"text":"Linux container","_key":"23c33fa61a841"},{"_type":"span","marks":[],"text":", the kernel version that's accessible from the repl has to match the kernel that is used in the machine itself. This means that as a happy side-effect, all repls can now access all the new features unlocked by this upgrade. Note that not ","_key":"23c33fa61a842"},{"_type":"span","marks":["em"],"text":"all","_key":"23c33fa61a843"},{"_type":"span","marks":[],"text":" ","_key":"23c33fa61a844"},{"_type":"span","marks":["em"],"text":"system calls","_key":"23c33fa61a845"},{"_type":"span","marks":[],"text":" are accessible from replspace (because that would be a security nightmare for us!), but we're still very excited to see all the new things that you will build with these new capabilities. Especially because this upgrade made several things a tiny bit faster, and those things tend to add up.","_key":"23c33fa61a846"}],"markDefs":[{"_key":"ad891e88a5fb","_type":"link","href":"https://blog.replit.com/killing-containers-at-scale#replit-architecture"}],"_type":"block","style":"normal"},{"_key":"ab5ebb54af31","children":[{"_type":"span","marks":[],"text":"We're huge proponents of building things that can then be used to ","_key":"ab5ebb54af310"},{"_type":"span","marks":["e355b7f2d57f"],"text":"build more things","_key":"ab5ebb54af311"},{"_type":"span","marks":[],"text":", especially for the next generation of programmers and engineers. This has a ","_key":"ab5ebb54af312"},{"_type":"span","marks":["3b18397a0f31"],"text":"compounding effect","_key":"ab5ebb54af313"},{"_type":"span","marks":[],"text":" because programmers in turn build things to make people's lives easier. If any of this inspired you to build something cool, let us know! And if you want to help us build the next big thing, ","_key":"ab5ebb54af314"},{"_type":"span","marks":["a4824c42376e"],"text":"we are hiring","_key":"ab5ebb54af315"},{"_type":"span","marks":[],"text":"!","_key":"ab5ebb54af316"}],"markDefs":[{"_key":"e355b7f2d57f","_type":"link","href":"https://blog.replit.com/betting-on-nix"},{"_key":"3b18397a0f31","_type":"link","href":"https://www.investopedia.com/terms/c/compounding.asp"},{"_key":"a4824c42376e","_type":"link","href":"https://replit.com/site/careers"}],"_type":"block","style":"normal"}],"publishedAt":"2021-11-11T21:30:00.000Z"}