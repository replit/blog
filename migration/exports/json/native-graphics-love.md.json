{"_id":"post-035e5b8b-831c-4368-bfeb-3bec7ffaacb1","_type":"post","title":"Native Graphics Love ❤️","slug":{"_type":"slug","current":"native-graphics-love"},"body":[{"_key":"3232b1c1f3fb","children":[{"_type":"span","marks":[],"text":"We have reimagined the native graphics experience on Replit. Our community of educators and hackers have given us ","_key":"3232b1c1f3fb0"},{"_type":"span","marks":["6bf2e956409b"],"text":"immense feedback on graphics performance and reliability","_key":"3232b1c1f3fb1"},{"_type":"span","marks":[],"text":".","_key":"3232b1c1f3fb2"}],"markDefs":[{"_key":"6bf2e956409b","_type":"link","href":"https://blog.repl.it/fix-gfx"}],"_type":"block","style":"normal"},{"_key":"da0288c85dca","children":[{"_type":"span","marks":[],"text":"Yes, ","_key":"da0288c85dca0"},{"_type":"span","marks":["dcdf4fa83ffc"],"text":"It Runs DOOM!","_key":"da0288c85dca1"}],"markDefs":[{"_key":"dcdf4fa83ffc","_type":"link","href":"https://itrunsdoom.tumblr.com/"}],"_type":"block","style":"normal"},{"_key":"3a5aea0db507","children":[{"_type":"span","marks":[],"text":"Our engineers have built a native graphics experience that is faster, more reliable, and elegant. Games and other native GUI applications launch quickly and reliably on our platform. Common issues like applications not launching and window resizing have been fixed. Among our most popular use cases is Pygame for beginner game programming and Java Swing for AP CSA students.","_key":"3a5aea0db5070"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"61bfcb4bcc5d","children":[{"_type":"span","marks":[],"text":"Engineering behind the scenes","_key":"61bfcb4bcc5d0"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"98a816fe2882","children":[{"_type":"span","marks":[],"text":"Before we take a peek behind the curtain, let's look at a very high-level view ofhow graphics work in practice. Like many Linux systems, Repl.it uses the ","_key":"98a816fe28820"},{"_type":"span","marks":["6b87f7ed8a85"],"text":"X Windows System","_key":"98a816fe28821"},{"_type":"span","marks":[],"text":" to display graphics. The X Windows System is natively a network-ready system: so there is one process that directly interacts with the hardware (the server), which doesn't need to be the on same machine where the program (the client) is being run. Nowadays, the networking capabilities of X are rarely used, since many optimizations rely on the fact that both the server and client processes run on the same machine and are able to share memory between them cheaply, to avoid having to move around massive amounts of graphics data through a narrow networking pipe. In order to support being able to view and interact with graphical user interfaces remotely other techologies are used, like ","_key":"98a816fe28822"},{"_type":"span","marks":["24c8bbb301ee"],"text":"VNC","_key":"98a816fe28823"},{"_type":"span","marks":[],"text":". And just for completeness' sake, X is not the only solution for graphics in Linux, and ","_key":"98a816fe28824"},{"_type":"span","marks":["45d7ab3504d0"],"text":"Wayland","_key":"98a816fe28825"},{"_type":"span","marks":[],"text":" is slowly becoming the alternative of choice for X. Android users will be more familiar with ","_key":"98a816fe28826"},{"_type":"span","marks":["d244f3d0b709"],"text":"SurfaceFlinger","_key":"98a816fe28827"},{"_type":"span","marks":[],"text":".","_key":"98a816fe28828"}],"markDefs":[{"_key":"6b87f7ed8a85","_type":"link","href":"https://en.wikibooks.org/wiki/Guide_to_X11/Introduction"},{"_key":"24c8bbb301ee","_type":"link","href":"https://en.wikipedia.org/wiki/Virtual_Network_Computing"},{"_key":"45d7ab3504d0","_type":"link","href":"https://wayland.freedesktop.org/"},{"_key":"d244f3d0b709","_type":"link","href":"https://source.android.com/devices/graphics/surfaceflinger-windowmanager"}],"_type":"block","style":"normal"},{"_key":"a88ba1c154f5","children":[{"_type":"span","marks":[],"text":"With that bit of history and context out of the way, let's look at how the previous solution for graphics was implemented: We relied on running ","_key":"a88ba1c154f50"},{"_type":"span","marks":["3f056eaecf6e"],"text":"the regular ","_key":"a88ba1c154f51"},{"_type":"span","marks":["3f056eaecf6e","code"],"text":"Xorg","_key":"a88ba1c154f52"},{"_type":"span","marks":["3f056eaecf6e"],"text":" server","_key":"a88ba1c154f53"},{"_type":"span","marks":[],"text":" and a magic version of ","_key":"a88ba1c154f54"},{"_type":"span","marks":["ac37cdb26cec","code"],"text":"x11vnc","_key":"a88ba1c154f55"},{"_type":"span","marks":[],"text":" that was able to talk the websocket protocol needed to be displayed from the client-side. This custom version of ","_key":"a88ba1c154f56"},{"_type":"span","marks":["code"],"text":"x11vnc","_key":"a88ba1c154f57"},{"_type":"span","marks":[],"text":" was more than a year old and hard to update. Starting up the server in every Repl is too expensive, so we were relying on the ","_key":"a88ba1c154f58"},{"_type":"span","marks":["e6a8795b7068","code"],"text":"LD_PRELOAD","_key":"a88ba1c154f59"},{"_type":"span","marks":["e6a8795b7068"],"text":" trick","_key":"a88ba1c154f510"},{"_type":"span","marks":[],"text":" by hooking invocations to ","_key":"a88ba1c154f511"},{"_type":"span","marks":["95d48eb9c144","code"],"text":"XOpenDisplay()","_key":"a88ba1c154f512"},{"_type":"span","marks":[],"text":" from ","_key":"a88ba1c154f513"},{"_type":"span","marks":["code"],"text":"libX11.so","_key":"a88ba1c154f514"},{"_type":"span","marks":[],"text":". This works well in ","_key":"a88ba1c154f515"},{"_type":"span","marks":["em"],"text":"most","_key":"a88ba1c154f516"},{"_type":"span","marks":[],"text":" cases, but not every single program that communicates with X uses this library, which causes it to not be ready under some circumstances. Two consequences of using the ","_key":"a88ba1c154f517"},{"_type":"span","marks":["code"],"text":"LD_PRELOAD","_key":"a88ba1c154f518"},{"_type":"span","marks":[],"text":" trick: ","_key":"a88ba1c154f519"},{"_type":"span","marks":["em"],"text":"every single","_key":"a88ba1c154f520"},{"_type":"span","marks":[],"text":" process that's started will have an extra bit of code that needs to be loaded beforehand, making processes a few milliseconds slower to launch even if they don't end up using the hooked function; the other consequence is that if any process uses a custom environment (or relies on the ","_key":"a88ba1c154f521"},{"_type":"span","marks":["code"],"text":"LD_PRELOAD","_key":"a88ba1c154f522"},{"_type":"span","marks":[],"text":" trick itself), this trick no longer works.","_key":"a88ba1c154f523"}],"markDefs":[{"_key":"3f056eaecf6e","_type":"link","href":"https://en.wikipedia.org/wiki/X.Org_Server"},{"_key":"ac37cdb26cec","_type":"link","href":"https://github.com/LibVNC/x11vnc"},{"_key":"e6a8795b7068","_type":"link","href":"https://jvns.ca/blog/2014/11/27/ld-preload-is-super-fun-and-easy/"},{"_key":"95d48eb9c144","_type":"link","href":"https://tronche.com/gui/x/xlib/display/opening.html"}],"_type":"block","style":"normal"},{"_key":"afc6ec55d057","children":[{"_type":"span","marks":[],"text":"In order to avoid having disembodied windows floating around and not being able to close them, we also need to be running a ","_key":"afc6ec55d0570"},{"_type":"span","marks":["7cd9c93f24ec"],"text":"Window Manager","_key":"afc6ec55d0571"},{"_type":"span","marks":[],"text":". We chose to use ","_key":"afc6ec55d0572"},{"_type":"span","marks":["b41b73316846"],"text":"Fluxbox","_key":"afc6ec55d0573"},{"_type":"span","marks":[],"text":" since it's fast and lean. One thing that happened every now and then was that the application startup and Fluxbox launch were running concurrently, so Fluxbox sometimes moved the window around to add the decorations, which caused applications to misbehave (the dreaded ","_key":"afc6ec55d0574"},{"_type":"span","marks":["code"],"text":"X_SetInputFocus","_key":"afc6ec55d0575"},{"_type":"span","marks":[],"text":" error!) and prompty crash on first launch.","_key":"afc6ec55d0576"}],"markDefs":[{"_key":"7cd9c93f24ec","_type":"link","href":"https://wiki.archlinux.org/index.php/window_manager"},{"_key":"b41b73316846","_type":"link","href":"http://fluxbox.org/"}],"_type":"block","style":"normal"},{"_key":"be813f0f6bd4","children":[{"_type":"span","marks":[],"text":"The solution for the performance issue was to use a more modern, combined X server + VNC server. ","_key":"be813f0f6bd40"},{"_type":"span","marks":["26dda5173008"],"text":"TigerVNC","_key":"be813f0f6bd41"},{"_type":"span","marks":[],"text":" was our first choice and we were happy with the improved performance and startup time. This also meant that we had one fewer process to take care of. In order to avoid using the ","_key":"be813f0f6bd42"},{"_type":"span","marks":["code"],"text":"LD_PRELOAD","_key":"be813f0f6bd43"},{"_type":"span","marks":[],"text":" trick, we took a page out of ","_key":"be813f0f6bd44"},{"_type":"span","marks":["56beacccb44f"],"text":"systemd's socket activation","_key":"be813f0f6bd45"},{"_type":"span","marks":[],"text":" feature, so that we detect the intent of a repl wanting to communicate with X by opening the socket to the X server, and launch the server + Window Manager at that point in time.","_key":"be813f0f6bd46"}],"markDefs":[{"_key":"26dda5173008","_type":"link","href":"https://tigervnc.org/"},{"_key":"56beacccb44f","_type":"link","href":"http://0pointer.de/blog/projects/socket-activation.html"}],"_type":"block","style":"normal"},{"_key":"5f614e773c1d","children":[{"_type":"span","marks":[],"text":"Finally, the solution for the crashes on launch was significantly simpler: just make sure that Fluxbox has finished initializing so that windows are not moved unintentionally and all the inputs are routed to the correct coordinates.","_key":"5f614e773c1d0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"88892211c3eb","children":[{"_type":"span","marks":[],"text":"Improving the Java Swing experience","_key":"88892211c3eb0"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"51b8a79447df","children":[{"_type":"span","marks":[],"text":"As part of this undertaking, we have boosted our Java repls to with more powerful virtual conatiners. Every Teams for Education user will now have 4x the power to compile and run ","_key":"51b8a79447df0"},{"_type":"span","marks":["em"],"text":"any","_key":"51b8a79447df1"},{"_type":"span","marks":[],"text":" Java project. This was essential to ensure that the Java Swing experience could be quick and reliable for teachers and students. Chromebook users should now see a dramatic improvement for all new Java projects.","_key":"51b8a79447df2"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"daa429d37b20","children":[{"_type":"span","marks":[],"text":"Checkout Barb Ericson's AP CS PhotoLab from the ","_key":"daa429d37b200"},{"_type":"span","marks":["7f913fa1afbb"],"text":"official CollegeBoard lab curriculum","_key":"daa429d37b201"},{"_type":"span","marks":[],"text":":","_key":"daa429d37b202"}],"markDefs":[{"_key":"7f913fa1afbb","_type":"link","href":"https://secure-media.collegeboard.org/digitalServices/pdf/ap/ap-compscia-picture-lab-student-guide.pdf"}],"_type":"block","style":"normal"},{"_type":"embed","_id":"0c29fb8c-b2f6-437f-8cf1-12f0ab2ee7fd","url":"https://repl.it/@demcrepl/PhotoLab?lite=true","_key":"3c4f3045443b"},{"_key":"b5bb16f1ccd8","children":[{"_type":"span","marks":[],"text":"Connect with us","_key":"b5bb16f1ccd80"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"8dc195e8d352","children":[{"_type":"span","marks":[],"text":"We will continue to invest in an improved native graphics experience. Native audio integration is next. Stay tuned! Want to chat about the future of native graphics? Connect directly with ","_key":"8dc195e8d3520"},{"_type":"span","marks":["12f0e5fdea17"],"text":"Luis","_key":"8dc195e8d3521"},{"_type":"span","marks":[],"text":".","_key":"8dc195e8d3522"}],"markDefs":[{"_key":"12f0e5fdea17","_type":"link","href":"mailto:luis@repl.it"}],"_type":"block","style":"normal"},{"_key":"ba202d43b81c","children":[{"_type":"span","marks":[],"text":"If building tools that redefine how people learn to code interests you, ","_key":"ba202d43b81c0"},{"_type":"span","marks":["cb0bad0aeff0"],"text":"join us","_key":"ba202d43b81c1"},{"_type":"span","marks":[],"text":".","_key":"ba202d43b81c2"}],"markDefs":[{"_key":"cb0bad0aeff0","_type":"link","href":"https://repl.it/site/careers"}],"_type":"block","style":"normal"},{"_key":"ff6d3c568f26","children":[{"_type":"span","marks":[],"text":"Giving Feedback Goes a Long Way","_key":"ff6d3c568f260"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"9b75e2b9998f","children":[{"_type":"span","marks":[],"text":"Teachers continue to express their enthusiasm for multiplayer Repls, annotations, and group projects. We will continue to build on these new platform features to provide a seamless collaborative experience for project based learning.","_key":"9b75e2b9998f0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"f26e2f473ce6","children":[{"_type":"span","marks":[],"text":"Are you dreaming of Repl.it features to make you a superhero in your classroom? We want to hear about it! Contact ","_key":"f26e2f473ce60"},{"_type":"span","marks":["081eb71e5277"],"text":"Derrick McMillen","_key":"f26e2f473ce61"},{"_type":"span","marks":[],"text":" directly via email. You can also leave feedback for us ","_key":"f26e2f473ce62"},{"_type":"span","marks":["a96134a6fbe2"],"text":"via Canny","_key":"f26e2f473ce63"},{"_type":"span","marks":[],"text":".","_key":"f26e2f473ce64"}],"markDefs":[{"_key":"081eb71e5277","_type":"link","href":"mailto:derrick@repl.it"},{"_key":"a96134a6fbe2","_type":"link","href":"https://repl.it/feedback/p/improved-gfx-and-gui"}],"_type":"block","style":"normal"},{"_key":"b0f94c8b9c57","children":[{"_type":"span","marks":[],"text":"Learn more about ","_key":"b0f94c8b9c570"},{"_type":"span","marks":["em"],"text":"Teams for Education","_key":"b0f94c8b9c571"},{"_type":"span","marks":[],"text":" in our ","_key":"b0f94c8b9c572"},{"_type":"span","marks":["8747d752431e"],"text":"documentation","_key":"b0f94c8b9c573"},{"_type":"span","marks":[],"text":".","_key":"b0f94c8b9c574"}],"markDefs":[{"_key":"8747d752431e","_type":"link","href":"https://docs.repl.it/Teams/"}],"_type":"block","style":"normal"}],"publishedAt":"2021-01-15T23:30:00.000Z"}