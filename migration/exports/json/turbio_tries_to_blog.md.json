{"_id":"post-529e36e0-798f-4df2-85ab-228a067ae38d","_type":"post","slug":{"_type":"slug","current":"turbio_tries_to_blog"},"body":[{"_key":"154e32e6df3d","children":[{"_type":"span","marks":[],"text":"If you've been using Replit for a while you might have noticed our multiplayer feature has gone through quite a few iterations. As it has evolved the infrastructure making it all work has been along for the ride. Each implementation unlocked important capabilities and pushed our infrastructure to be better.","_key":"154e32e6df3d0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"93e6fa4f6b6e","children":[{"_type":"span","marks":[],"text":"Our very first implementation of multiplayer was intentionally kept simple. We reached for what we deemed well established and supported libraries in the community. This lead us to a stack with ","_key":"93e6fa4f6b6e0"},{"_type":"span","marks":["f2524de212d5"],"text":"our editor","_key":"93e6fa4f6b6e1"},{"_type":"span","marks":[],"text":" talking ","_key":"93e6fa4f6b6e2"},{"_type":"span","marks":["c76356f9a549"],"text":"operational transform","_key":"93e6fa4f6b6e3"},{"_type":"span","marks":[],"text":" to ","_key":"93e6fa4f6b6e4"},{"_type":"span","marks":["ea12709eaa35"],"text":"sharejs","_key":"93e6fa4f6b6e5"},{"_type":"span","marks":[],"text":" backed by ","_key":"93e6fa4f6b6e6"},{"_type":"span","marks":["5ef575eb281e"],"text":"mongodb","_key":"93e6fa4f6b6e7"},{"_type":"span","marks":[],"text":" to coordinate edits between clients. This meant supporting additional infrastructure but required very little code and no changes to what we were already running. There were some significant downsides though. Being purely client based multiplayer sessions would rely on the host for coordination and thus only live as long as the host. Clients needed to send file contents to their repls when they run. Lots of scaling issues. We wanted to preserve OT history efficiently. Probably more. Shit on mongo db a lil, i hear that's hot. It wasn't very stable right guys?","_key":"93e6fa4f6b6e8"}],"markDefs":[{"_key":"f2524de212d5","_type":"link","href":"linktomonacoblogpost"},{"_key":"c76356f9a549","_type":"link","href":"yep"},{"_key":"ea12709eaa35","_type":"link","href":"yep"},{"_key":"5ef575eb281e","_type":"link","href":"yep"}],"_type":"block","style":"normal"},{"_key":"360969ec0575","children":[{"_type":"span","marks":[],"text":"We were surprised to find what looked to be the state of the art open source collaborative editing appeared to have many serious flaws. After beginning to roll out multiplayer we found a myriad of bugs stemming from libraries we depended on. ","_key":"360969ec05750"},{"_type":"span","marks":["em"],"text":"talk a lil shit about sharejs n friends","_key":"360969ec05751"},{"_type":"span","marks":[],"text":"! i forget what the issues were but we diverged and had catch up problems iirc?","_key":"360969ec05752"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"13ac78ade155","children":[{"_type":"span","marks":[],"text":"To move forward we wanted to dramatically simplify the inner workings of multiplayer and own much more of the vertical. Although this meant more work up front, having simpler code we understood sounded a lot better than gluing together libraries we didn't. After surveying the existing technology we settle on a very simple version of unicode text based operational transform. OT, we found, was well understood, simpler than any alternatives, and most importantly we could wrap our heads around it. Collaborative editing was redesigned more like a regular desktop application to on top of our existing code evaluation infrastructure.","_key":"13ac78ade1550"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"60d0288cf43b","children":[{"_type":"span","marks":[],"text":"Some major protocol changes later making [natively concurrent and mutliseat](link to that blog post) and this was decidedly the way multiplayer should work.","_key":"60d0288cf43b0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"97e3a5a1d8bb","children":[{"_type":"span","marks":[],"text":"But first you probably want some background on our code evaluation infrastructure. We call it Goval internally and it's awesome. It starts up hundreds of repls every second all day every day. But to be this awesome it has an important caveat: it can kill your repl at any time for any reason. If you decide you want to keep repling you'll have to boot the repl up from scratch and start again at the last checkpoint. This takes lots of careful consideration from the client to keep things moving along smoothly. Although a tricky trade off we've decided it's worth it.","_key":"97e3a5a1d8bb0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"711e99ade1f9","children":[{"_type":"span","marks":[],"text":"Collaborative editing is build right in to your repl (actually packed into the init process), running right next to your ","_key":"711e99ade1f90"},{"_type":"span","marks":["code"],"text":"main.py","_key":"711e99ade1f91"},{"_type":"span","marks":[],"text":" and ","_key":"711e99ade1f92"},{"_type":"span","marks":["eaaefe1ce6ce"],"text":"language server","_key":"711e99ade1f93"},{"_type":"span","marks":[],"text":". This poses some interesting technical problems as we need to follow the rules of userland. The trade-offs are easily worth it, the code is exceedingly simple and focused only on the task at hand. Code that runs in a repl needn't worry about scaling, servers, routing, or any other craziness the web often entails. That's already handled by our infrastructure for free. Once you get right down to it we're just dealing with a good ol' ","_key":"711e99ade1f94"},{"_type":"span","marks":["dd3a69c6c715"],"text":"unix system","_key":"711e99ade1f95"},{"_type":"span","marks":[],"text":".","_key":"711e99ade1f96"}],"markDefs":[{"_key":"eaaefe1ce6ce","_type":"link","href":"yep"},{"_key":"dd3a69c6c715","_type":"link","href":"memes"}],"_type":"block","style":"normal"},{"_key":"662ad4fb112b","children":[{"_type":"span","marks":[],"text":"When setting out on this journey we needed to face some unfortunate truths. Writing correct code is hard. Writing correct code to do operation transform is ","_key":"662ad4fb112b0"},{"_type":"span","marks":["em"],"text":"really","_key":"662ad4fb112b1"},{"_type":"span","marks":[],"text":" hard. To balance with human fallibility we put significant effort into error detection, reporting, and recovery. When things go wrong we try to crash as fast and loud as we can. This might not always lead to the best user experience","_key":"662ad4fb112b2"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"4b94443f69b3","children":[{"_type":"span","marks":[],"text":"Although we trusted our OT test suite was good, we also trusted our users to fuzz the shit out of us bro.","_key":"4b94443f69b30"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"b65ec0274787","children":[{"_type":"span","marks":[],"text":"Before making any attempts to change stuff we've put a lot of work.","_key":"b65ec02747870"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"fda6271780db","children":[{"_type":"span","marks":[],"text":"no multiplayer -> going live -> always multiplayer -> multiplayer native","_key":"fda6271780db0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"bc76aa6490b3","children":[{"_type":"span","marks":[],"text":"coming soon: multiplayer native aka product catches up with infra","_key":"bc76aa6490b30"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"97005132e8f2","children":[{"_type":"span","marks":[],"text":"NOOOTES","_key":"97005132e8f20"}],"markDefs":[],"_type":"block","style":"h1"},{"_key":"bfc1887e8eca","children":[{"_type":"span","marks":[],"text":"everything was on the client, life was easy","_key":"bfc1887e8eca0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"fea3dac1d9a8","children":[{"_type":"span","marks":[],"text":"went multiplayer. read all about it here ","_key":"fea3dac1d9a80"},{"_type":"span","marks":["6e626906e56d"],"text":"https://blog.repl.it/multi","_key":"fea3dac1d9a81"}],"markDefs":[{"_key":"6e626906e56d","_type":"link","href":"https://blog.repl.it/multi"}],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"79990cc92b70","children":[{"_type":"span","marks":[],"text":"life got a lot harder","_key":"79990cc92b700"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"c6f25898e000","children":[{"_type":"span","marks":[],"text":"should we mention?: we regressed","_key":"c6f25898e0000"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"cc09c0c61fe2","children":[{"_type":"span","marks":[],"text":"our infra is based on ephemeral stuff, we need to be highly crash recoverable","_key":"cc09c0c61fe20"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"719dc3d80ebb","children":[{"_type":"span","marks":[],"text":"scaling was $0","_key":"719dc3d80ebb0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"3e5ef306690a","children":[{"_type":"span","_key":"3e5ef306690a0","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_type":"image","_sanityAsset":"image@https://blog.replit.com/images/ot_ops_graph.png","_key":"1a0e5921edf4"},{"_key":"0b2807b94854","children":[{"_type":"span","marks":[],"text":"ot in an ephemeral world is kinda tricky","_key":"0b2807b948540"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"ae7d52622069","children":[{"_type":"span","marks":[],"text":"checksuming, sometimes you find bugs in you libs","_key":"ae7d526220690"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"d0814948f77e","children":[{"_type":"span","marks":[],"text":"ot history mayb","_key":"d0814948f77e0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"44ac3f9b92ff","children":[{"_type":"span","marks":[],"text":"chipping away at all the possible states ","_key":"44ac3f9b92ff0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"c14359ddc45b","children":[{"_type":"span","_key":"c14359ddc45b0","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal","level":2,"listItem":"bullet"},{"_type":"image","_sanityAsset":"image@https://blog.replit.com/images/crc32_mismatch.png","_key":"dd3f590611da"},{"_key":"cc2b9ee6add5","children":[{"_type":"span","_key":"cc2b9ee6add50","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal","level":2,"listItem":"bullet"},{"_type":"image","_sanityAsset":"image@https://blog.replit.com/images/prompted_percent.png","_key":"15cb2c697922"},{"_key":"bda86115cf78","children":[{"_type":"span","marks":[],"text":"we found lots of dumb bugs ","_key":"bda86115cf780"}],"markDefs":[],"_type":"block","style":"normal","level":2,"listItem":"bullet"},{"_key":"f155352936f5","children":[{"_type":"span","marks":["607f52c1a714"],"text":"https://github.com/josephg/unicount/pull/1","_key":"f155352936f50"}],"markDefs":[{"_key":"607f52c1a714","_type":"link","href":"https://github.com/josephg/unicount/pull/1"}],"_type":"block","style":"normal","level":3,"listItem":"bullet"},{"_key":"381e6b33459f","children":[{"_type":"span","marks":["e96a6534f442"],"text":"https://github.com/protobufjs/protobuf.js/pull/1486","_key":"381e6b33459f0"}],"markDefs":[{"_key":"e96a6534f442","_type":"link","href":"https://github.com/protobufjs/protobuf.js/pull/1486"}],"_type":"block","style":"normal","level":3,"listItem":"bullet"},{"_key":"b64bf23cd502","children":[{"_type":"span","marks":[],"text":"monaco's newline fuckery    ","_key":"b64bf23cd5020"}],"markDefs":[],"_type":"block","style":"normal","level":3,"listItem":"bullet"},{"_key":"458855dcea67","children":[{"_type":"span","marks":[],"text":"monaco reports it as one character even on windows","_key":"458855dcea670"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"543204564019","children":[{"_type":"span","marks":[],"text":"the offsets are messed up!","_key":"5432045640190"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"53bbf7b7b43b","children":[{"_type":"span","marks":[],"text":"monaco normalizes the buffer into a single type of newline","_key":"53bbf7b7b43b0"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"8494ee1bf1e8","children":[{"_type":"span","marks":[],"text":"theycan say the line endings are","_key":"8494ee1bf1e80"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"92a816b13281","children":[{"_type":"span","marks":[],"text":"user file content can container a mix","_key":"92a816b132810"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"17d44baa234b","children":[{"_type":"span","marks":[],"text":"we need to report hte right","_key":"17d44baa234b0"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"b5bc530490c3","children":[{"_type":"span","marks":[],"text":"we store the actual characters","_key":"b5bc530490c30"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"badcbc81b830","children":[{"_type":"span","marks":[],"text":"when we see monacdo's characters we walk the characters to get the real offset","_key":"badcbc81b8300"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"6d0f24c5e2f0","children":[{"_type":"span","marks":[],"text":"change monaco to always use \\n","_key":"6d0f24c5e2f00"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"},{"_key":"7c4bbfb098fc","children":[{"_type":"span","marks":[],"text":"if the file actually was","_key":"7c4bbfb098fc0"}],"markDefs":[],"_type":"block","style":"normal","level":4,"listItem":"bullet"}]}