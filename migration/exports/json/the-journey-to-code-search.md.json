{"_id":"post-39fc5f6e-7ce0-4bee-9dc8-3ad9f7f6b29e","_type":"post","title":"The Journey To Code Search","slug":{"_type":"slug","current":"the-journey-to-code-search"},"body":[{"_key":"a78fbc8391fb","children":[{"_type":"span","_key":"a78fbc8391fb0","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"31d793554595","children":[{"_type":"span","marks":[],"text":"Finding that one comment, class, or function in your codebase is important. You might not always know where to look... which is why we created a brand new Code Search tool! From simple queries to regular expressions it has never been easier to get work done on Replit. The new Code Search tool supports queries with word filters, regular expressions, include patterns, exclude patterns, as well as replacements (with regular expression capture group support) so that you can find what you need and make refactors on larger codebases quickly and efficiently. Try it out now on Replit! But don't forget to come back to this post so we can bring you on our Journey to Code Search.","_key":"31d7935545950"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"2255dbfce1a2","children":[{"_type":"span","_key":"2255dbfce1a20","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"ca0c4380ebd2","children":[{"_type":"span","marks":[],"text":"How It All Started","_key":"ca0c4380ebd20"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"a99445a7969c","children":[{"_type":"span","marks":[],"text":"At Replit we love building things. So much so that we get together to do it pretty regularly! During a Hack Week in 2023 @nathan-pham, @monkatraz, @masad-frost, and @cdmistman all got down to business working out how we could make the search experience in the workspace better. From there, the project was born and quickly became a reality. Though, there are a surprising number of problems to solve in order to make Code Search fast, efficient, and as useful as we wanted it to be.","_key":"a99445a7969c0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"4cdb78a66884","children":[{"_type":"span","marks":[],"text":"Nathan Pham did a whole bunch of work to build out the systems needed to make Code Search work. His internship ended this last April, but we're very thankful for all of the work he did and the great energy he brought while he was here. Nathan also wrote up some posts detailing ","_key":"4cdb78a668840"},{"_type":"span","marks":["351c84a5feea"],"text":"what it is like to intern at Replit","_key":"4cdb78a668841"},{"_type":"span","marks":[],"text":" as well as creating an ","_key":"4cdb78a668842"},{"_type":"span","marks":["0c43a30ef10b"],"text":"introduction to Code Search","_key":"4cdb78a668843"},{"_type":"span","marks":[],"text":".","_key":"4cdb78a668844"}],"markDefs":[{"_key":"351c84a5feea","_type":"link","href":"https://blog.replit.com/internship-experience-at-replit"},{"_key":"0c43a30ef10b","_type":"link","href":"https://introducing-code-search.util.repl.co/"}],"_type":"block","style":"normal"},{"_key":"b2d5de5ee83c","children":[{"_type":"span","marks":[],"text":"How Does One Search","_key":"b2d5de5ee83c0"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"5a76e09f52b7","children":[{"_type":"span","marks":[],"text":"The first question we needed to ask is how to actually perform a search on a Repl. We knew we didn't want to compromise on performance, feedback should be as immediate as possible so you can maintain your flow while developing. We also knew that there were some great projects. To meet these needs, we reached for ","_key":"5a76e09f52b70"},{"_type":"span","marks":["dbcc0d8cac28"],"text":"ripgrep","_key":"5a76e09f52b71"},{"_type":"span","marks":[],"text":".","_key":"5a76e09f52b72"}],"markDefs":[{"_key":"dbcc0d8cac28","_type":"link","href":"https://github.com/BurntSushi/ripgrep"}],"_type":"block","style":"normal"},{"_key":"f08b605e52ff","children":[{"_type":"span","marks":[],"text":"In order to run our search, we need to work with the Repl container service to run ","_key":"f08b605e52ff0"},{"_type":"span","marks":["code"],"text":"rg","_key":"f08b605e52ff1"},{"_type":"span","marks":[],"text":" with the appropriate arguments for our search and then send the result back to the client. We use ","_key":"f08b605e52ff2"},{"_type":"span","marks":["8cf201d00dd2"],"text":"crosis","_key":"f08b605e52ff3"},{"_type":"span","marks":[],"text":" to make this happen:","_key":"f08b605e52ff4"}],"markDefs":[{"_key":"8cf201d00dd2","_type":"link","href":"https://github.com/replit/crosis"}],"_type":"block","style":"normal"},{"_type":"codeBlock","language":"text","codeContent":"async function search(query) {\n    const { output, error } = await container.exec(\"rg\", \"--\", query);\n\n    if (error) {\n        return {\n            error,\n            results: null,\n        };\n    }\n\n    return {\n        error: null,\n        // Turn the raw output lines into some structured data so we can display it in the search results.\n        results: parseRgOutput(output),\n    };\n}\n","_key":"6e8ed752ca1e"},{"_key":"82502a3380b9","children":[{"_type":"span","marks":[],"text":"Stream Me Baby One More Time","_key":"82502a3380b90"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"c2a171388c62","children":[{"_type":"span","marks":[],"text":"Waiting for the whole search to finish before retrieving results is slow. Instead, we can take advantage of crosis's ability to stream the output back to us in chunks that we can parse and display on the fly. It may seem small, but from this simple change we get an average 40% faster in showing search results. This first response also often contains more than enough results to fill the visible search area, making Code Search feel significantly more responsive.","_key":"c2a171388c620"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"1cc2ceaccb30","children":[{"_type":"span","marks":[],"text":"However, while streaming results back gives us a boost for initial responsiveness, two problems arise: rendering performance and truncating results. In order to keep the web view performant we need to limit the number of results we process. This goes for both the results rendered to the page as well as the ones held in memory. To avoid bringing your IDE to a crawl, we employ a few techniques:","_key":"1cc2ceaccb300"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"3c049fb73f13","children":[{"_type":"span","marks":[],"text":"List Virtualization","_key":"3c049fb73f130"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"b9b14f708063","children":[{"_type":"span","marks":[],"text":"To avoid rendering thousands of new elements to the page for every search, we make use of ","_key":"b9b14f7080630"},{"_type":"span","marks":["35f8a62af07d","code"],"text":"@tanstack/react-virtual","_key":"b9b14f7080631"},{"_type":"span","marks":[],"text":". By estimating heights of the would-be DOM nodes and tracking the scroll position in our search results, we can intelligently add and remove DOM nodes as needed when they would become visible. Now instead of rendering every single search result at the same time, only the ones in the visible area are created!","_key":"b9b14f7080632"}],"markDefs":[{"_key":"35f8a62af07d","_type":"link","href":"https://github.com/TanStack/virtual"}],"_type":"block","style":"normal"},{"_key":"9df731a8ce7b","children":[{"_type":"span","marks":[],"text":"Output Limits","_key":"9df731a8ce7b0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"number"},{"_key":"e92b415a085b","children":[{"_type":"span","marks":[],"text":"Some search queries like \"","_key":"e92b415a085b0"},{"_type":"span","marks":["83a0cd4463eb"],"text":"a","_key":"e92b415a085b1"},{"_type":"span","marks":[],"text":"\" can result in ","_key":"e92b415a085b2"},{"_type":"span","marks":["em"],"text":"many","_key":"e92b415a085b3"},{"_type":"span","marks":[],"text":" matches and we both know you weren't going to look through all 300MB of search results, right? Instead, we give ","_key":"e92b415a085b4"},{"_type":"span","marks":["code"],"text":"rg","_key":"e92b415a085b5"},{"_type":"span","marks":[],"text":" a hard cut-off of 32kb. We found that is plenty to give quite a few results to search through while still being small enough to ensure even a few instances of Code Search open at the same time won't be an issue. Since we're streaming the result back, we now have to be more defensive in our parsing of the search results output since arbitrarily cutting the output off like this can yield a malformed line.","_key":"e92b415a085b6"}],"markDefs":[{"_key":"83a0cd4463eb","_type":"link","href":"https://www.youtube.com/shorts/GDHbHhIgiFk"}],"_type":"block","style":"normal"},{"_key":"7dc8d32bdee9","children":[{"_type":"span","marks":[],"text":"With these changes, we saw a pretty big leap in initial responsiveness:","_key":"7dc8d32bdee90"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"bfd864d69a8b","children":[{"_type":"span","marks":[],"text":"Repl Boost Initial Response (Avg.) Initial Streaming Response (Avg.) 0x 338.3ms 137.7ms 8x 316.0ms 129.1ms 32x 230.7ms 98.7ms","_key":"bfd864d69a8b0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"83a8da793e05","children":[{"_type":"span","marks":[],"text":"10x Code Searcher","_key":"83a8da793e050"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"2eeb10d5736b","children":[{"_type":"span","marks":[],"text":"With the search system itself performing well, we started rallying around the UI and UX to get the tool polished for developers to start using! We worked to make our in-editor search consistent with the new Code Search tool's visual style and shifted towards making Code Search more powerful than what you may be used to. The brand new Code Search tool comes with some extremely useful features:","_key":"2eeb10d5736b0"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"46615e6528c5","children":[{"_type":"span","marks":[],"text":"Multiple Panes","_key":"46615e6528c50"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"b5578c3230a5","children":[{"_type":"span","marks":[],"text":"That's right, you can have multiple searches open at the same time! They stay separate so you can maintain your context when you're working instead of having to retype the same set of queries over and over.","_key":"b5578c3230a50"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"3f60f1765c5f","children":[{"_type":"span","_key":"3f60f1765c5f0","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"20593a662957","children":[{"_type":"span","marks":[],"text":"History","_key":"20593a6629570"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"fb8337e43012","children":[{"_type":"span","marks":[],"text":"Retype your queries? What is this, 1970? Hit the Up and Down arrows when you're focused on the search field to go to the previous or next query you entered!","_key":"fb8337e430120"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"856dc98c3822","children":[{"_type":"span","_key":"856dc98c38220","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"9bd74b629b7f","children":[{"_type":"span","marks":[],"text":"Include / Exclude","_key":"9bd74b629b7f0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"a79904afa859","children":[{"_type":"span","marks":[],"text":"Filter search results to only be from a certain directory, matching a certain file type, or anything else you can do with a glob. You can also filter search results to remove certain patterns. In fact, you can use both of these together!","_key":"a79904afa8590"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"7765100b2f6f","children":[{"_type":"span","_key":"7765100b2f6f0","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"c99cc316631f","children":[{"_type":"span","marks":[],"text":"Regular Expressions","_key":"c99cc316631f0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"6826ba0af505","children":[{"_type":"span","marks":[],"text":"Regular Expression search is helpful when the results you want are all slightly different. This feature really shines when performing a replace, using capture groups. Super charge your next big code refactor!","_key":"6826ba0af5050"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"a58980288d39","children":[{"_type":"span","_key":"a58980288d390","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"728b5a98e6db","children":[{"_type":"span","marks":[],"text":"Keyboard Navigation","_key":"728b5a98e6db0"}],"markDefs":[],"_type":"block","style":"normal","level":1,"listItem":"bullet"},{"_key":"8fd24f96f6c1","children":[{"_type":"span","marks":[],"text":"Who needs a mouse when you can navigate search results with Tab, Up, Down, Left, and Right to jump between files, lines, and matches. Give it a try and see how quickly you toss that old pointing device in the bin!","_key":"8fd24f96f6c10"}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"c64028ade71e","children":[{"_type":"span","_key":"c64028ade71e0","text":"","marks":[]}],"markDefs":[],"_type":"block","style":"normal"},{"_key":"358a42ed6dd9","children":[{"_type":"span","marks":[],"text":"Mount Code Search","_key":"358a42ed6dd90"}],"markDefs":[],"_type":"block","style":"h2"},{"_key":"8ea00605be33","children":[{"_type":"span","marks":[],"text":"While it may seem like we've reached the peak, there are still a lot of awesome features and support we want to build around Code Search. We'll be working on making Code Search even better and you're welcome to ","_key":"8ea00605be330"},{"_type":"span","marks":["db4c4936e7d4"],"text":"join us","_key":"8ea00605be331"},{"_type":"span","marks":[],"text":"! If you like solving problems and building great tools for developers then drop us a line. Or if you have any ideas that would make Code Search even better ","_key":"8ea00605be332"},{"_type":"span","marks":["10bcdda4e28f"],"text":"let us know","_key":"8ea00605be333"},{"_type":"span","marks":[],"text":"!","_key":"8ea00605be334"}],"markDefs":[{"_key":"db4c4936e7d4","_type":"link","href":"https://replit.com/site/careers"},{"_key":"10bcdda4e28f","_type":"link","href":"https://ask.replit.com"}],"_type":"block","style":"normal"}],"publishedAt":"2023-06-25T00:00:00.000Z"}